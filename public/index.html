<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Notas Fiscais de Saída</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }

    button,
    input,
    select,
    textarea {
      font-family: "Inter", sans-serif;
    }

    body {
      font-family: "Inter", sans-serif;
      margin: 0;
      padding: 24px;
      background: #161618;
      color: #fafafa;
      min-height: 100vh;
    }

    .container {
      max-width: 1240px;
      margin: 0 auto;
    }

    h1 {
      font-size: 28px;
      font-weight: 600;
      margin-bottom: 24px;
      color: #fafafa;
    }

    .card {
      background: #1D1D20;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
      max-width: 1240px;
      border: 1px solid #27272A;
    }

    .card.card-table {
      padding: 0;
    }

    .card h2 {
      font-size: 0.95rem;
      font-weight: 600;
      margin: 0 0 16px 0;
      color: #fafafa;
    }

    .form-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .form-row-emitir {
      width: 100%;
    }

    .form-row-emitir .form-group {
      flex: 1;
      min-width: 0;
    }

    .form-row-emitir select,
    .form-row-emitir input[type="number"] {
      width: 100%;
      min-width: 0;
      max-width: none;
      box-sizing: border-box;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      font-size: 14px;
      font-weight: 500;
      color: #a1a1aa;
    }

    select {
      min-width: 220px;
      height: 40px;
      padding: 0 12px;
      border: 1px solid #27272A;
      border-radius: 8px;
      background: #161618;
      color: #fafafa;
      font-size: 0.95rem;
    }

    select:focus {
      outline: none;
      border-color: #D7A404;
      box-shadow: 0 0 0 3px #D7A40414;
    }

    input[type="number"] {
      width: 120px;
      height: 40px;
      padding: 0 12px;
      border: 1px solid #27272A;
      border-radius: 8px;
      background: #161618;
      color: #fafafa;
      font-size: 1rem;
      appearance: textfield;
      -moz-appearance: textfield;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      appearance: none;
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"]:focus {
      outline: none;
      border-color: #D7A404;
      box-shadow: 0 0 0 3px #D7A40414;
    }

    button {
      display: flex;
      gap: 8px;
      margin: 0;
      padding: 10px 12px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      z-index: unset;
      align-self: unset;
      max-width: unset;
      min-width: unset;
      height: auto;
      max-height: 40px;
      min-height: 40px;
      transition: 0.3s;
    }

    button.primary {
      background: #fafafa;
      color: #161618;
    }

    button.primary:hover {
      background: #e4e4e7;
    }

    button.primary:disabled {
      background: #a1a1aa;
      color: #71717a;
      cursor: not-allowed;
    }

    button.small {
      background: #E4E4E7;
      color: #161618;
      padding: 10px 12px;
      font-size: 0.85rem;
      max-height: 40px;
      min-height: 40px;
    }

    button.small:hover {
      background: #d4d4d8;
    }

    button.btn-verificar-chamada {
      background: #27272A;
      color: #fafafa;
    }

    button.btn-verificar-chamada:hover {
      background: #3f3f46;
    }

    button.btn-sync {
      background: #27272A;
      color: #fafafa;
    }

    button.btn-sync:hover {
      background: #3f3f46;
    }

    .message {
      margin-top: 12px;
      padding: 12px;
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .message.success {
      background: #14532d;
      color: #86efac;
    }

    .message.error {
      background: #7f1d1d;
      color: #fca5a5;
    }

    .message.info {
      background: #1e3a5f;
      color: #93c5fd;
    }

    .invoice-filters-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .invoice-search {
      position: relative;
      flex: 1 1 220px;
      max-width: 250px;
    }

    .invoice-search input {
      width: 100%;
      padding: 8px 40px 8px 14px;
      border-radius: 8px;
      border: 1px solid #27272A;
      background: #1D1D20;
      color: #fafafa;
      font-size: 0.9rem;
    }

    .invoice-search input::placeholder {
      color: #71717a;
    }

    .invoice-search button {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      color: #a1a1aa;
      width: 16px;
      height: 16px;
      padding: 0;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .invoice-search button:hover {
      color: #e4e4e7;
      background: #27272A;
    }

    .invoice-search button i {
      width: 16px;
      height: 16px;
    }

    .invoice-filter-select {
      min-width: 0;
      flex: 0 0 auto;
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 0;
    }

    .invoice-filter-select select {
      display: none;
    }

    .invoice-filter-select.with-prefix-icon .filter-prefix-icon {
      position: absolute;
      left: 12px;
      width: 16px;
      height: 16px;
      color: #fafafa;
      pointer-events: none;
    }

    .filter-dropdown-trigger {
      border-radius: 8px;
      border: 1px solid #27272A;
      background: #1D1D20;
      color: #fafafa;
      font-size: 0.9rem;
      padding: 6px 12px 6px 36px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      white-space: nowrap;
      min-width: 0;
      font-family: inherit;
    }

    .filter-dropdown-trigger:hover {
      background: #27272A;
      border-color: #27272A;
    }

    .filter-dropdown-label {
      display: inline-block;
      flex-shrink: 0;
    }

    .filter-dropdown-sep {
      color: #71717a;
      flex-shrink: 0;
      user-select: none;
    }

    .filter-dropdown-value {
      display: inline-flex;
      align-items: center;
      background: #27272A;
      border-radius: 6px;
      padding: 2px 5px;
      font-weight: 500;
      min-height: 24px;
      box-sizing: border-box;
      font-size: 12px;
    }

    .filter-dropdown-value:empty {
      display: none;
    }

    .filter-dropdown-sep:has(+ .filter-dropdown-value:empty) {
      display: none;
    }

    .filter-dropdown-menu {
      position: absolute;
      left: 0;
      top: calc(100% + 4px);
      background: #1D1D20;
      border-radius: 8px;
      border: 1px solid #27272A;
      min-width: 189px;
      padding: 4px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      z-index: 40;
      display: none;
    }

    .invoice-filter-select.open .filter-dropdown-menu {
      display: block;
    }

    .filter-dropdown-option {
      width: 100%;
      height: 32px;
      min-height: 32px;
      padding: 0 12px;
      display: flex;
      align-items: center;
      background: transparent;
      border: none;
      text-align: left;
      color: #fafafa;
      font-size: 0.9rem;
      cursor: pointer;
      white-space: nowrap;
      font-weight: 400;
      font-family: inherit;
      box-sizing: border-box;
      border-radius: 4px;
    }

    .filter-dropdown-option:hover,
    .filter-dropdown-option.filter-option-selected {
      background: #27272A;
    }

    .filter-dropdown-clear-wrap {
      border-top: 1px solid #27272A;
      padding-top: 4px;
      margin-top: 4px;
    }

    .filter-dropdown-option.filter-dropdown-clear {
      height: 32px;
      min-height: 32px;
      color: #fafafa;
      justify-content: center;
    }

    .filter-dropdown-option.filter-dropdown-clear:hover {
      color: #fafafa;
    }

    .invoice-filter-select select:focus {
      outline: none;
      border-color: #fafafa;
      box-shadow: 0 0 0 1px #fafafa;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    #invoiceList table {
      display: block;
    }

    #invoiceList table thead,
    #invoiceList table tbody {
      display: block;
    }

    #invoiceList table tr {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    #invoiceList table tbody tr {
      height: 63px;
    }

    #invoiceList table tbody tr:hover {
      background: #27272A;
    }

    #invoiceList table th,
    #invoiceList table td {
      flex: 1 1 0;
      min-width: 0;
      display: flex;
      align-items: center;
      height: 63px;
      box-sizing: border-box;
    }

    #invoiceList table thead tr {
      height: 48px;
    }

    #invoiceList table thead tr th {
      height: 48px;
    }

    #invoiceList table th:nth-child(1),
    #invoiceList table td:nth-child(1) {
      flex: 0 0 120px;
      width: 120px;
    }

    #invoiceList table th:nth-child(2),
    #invoiceList table td:nth-child(2) {
      flex: 0 0 160px;
      width: 160px;
    }

    #invoiceList table th:nth-child(3),
    #invoiceList table td:nth-child(3) {
      flex: 1 1 0;
      min-width: 140px;
    }

    #invoiceList table th:nth-child(4),
    #invoiceList table td:nth-child(4) {
      flex: 0 0 200px;
      width: 200px;
    }

    #invoiceList table th:nth-child(5),
    #invoiceList table td:nth-child(5) {
      flex: 0 0 160px;
      width: 160px;
    }

    #invoiceList table th:nth-child(6),
    #invoiceList table td:nth-child(6) {
      flex: 0 0 120px;
      width: 120px;
    }

    #invoiceList table td:nth-child(6) {
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    th,
    td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #27272A;
    }

    #invoiceList table th,
    #invoiceList table td {
      padding: 10px 16px;
    }

    th {
      color: #a1a1aa;
      font-weight: 400;
    }

    .status {
      display: inline-block;
      padding: 4px 6px;
      border-radius: 6px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .status.AUTORIZADO {
      background: #56db6533;
      color: #56db65;
    }

    .status.PROCESSANDO,
    .status.PENDENTE {
      background: #D9770833;
      color: #D97708;
    }

    .status.REJEITADO {
      background: #B8282833;
      color: #B82828;
    }

    .status.ERRO {
      background: #dc262633;
      color: #dc2626;
    }

    .status.RASCUNHO {
      background: #27272A33;
      color: #a1a1aa;
    }

    .status.clickable {
      cursor: pointer;
      text-decoration: none;
    }

    .status.clickable:hover {
      opacity: 0.9;
    }

    .actions {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
    }

    .empty {
      color: #a1a1aa;
      padding: 24px;
      text-align: center;
    }

    .skeleton-table {
      width: 100%;
    }

    .skeleton-table thead tr {
      height: 48px;
    }

    .skeleton-table tbody tr {
      height: 63px;
    }

    .skeleton-table th,
    .skeleton-table td {
      padding: 10px 16px;
      vertical-align: middle;
    }

    .skeleton-table th {
      color: #a1a1aa;
      font-weight: 400;
      font-size: 14px;
    }

    .skeleton-bar {
      height: 14px;
      border-radius: 4px;
      background: linear-gradient(90deg, #27272A 25%, #3f3f46 50%, #27272A 75%);
      background-size: 200% 100%;
      animation: skeleton-shimmer 1.2s ease-in-out infinite;
    }

    .skeleton-bar.short {
      max-width: 60px;
    }

    .skeleton-bar.medium {
      max-width: 100px;
    }

    .skeleton-bar.long {
      max-width: 180px;
    }

    .skeleton-bar.full {
      width: 80%;
    }

    .skeleton-table td:nth-child(6) .skeleton-bar {
      max-width: 80px;
      margin-left: auto;
    }

    @keyframes skeleton-shimmer {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    body.body-scroll-lock {
      overflow: hidden !important;
      touch-action: none;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 100;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: #1D1D20;
      border-radius: 8px;
      border: 1px solid #27272A;
      max-width: 640px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal .modal-header,
    .modal .modal-footer {
      flex-shrink: 0;
    }

    .modal .modal-body {
      flex: 1;
      min-height: 0;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }

    .modal-header {
      display: flex;
      align-items: center;
      height: 56px;
      padding: 16px 24px;
      border-bottom: 1px solid #27272A;
    }

    .modal-header::before {
      content: '';
      width: 40px;
      flex-shrink: 0;
    }

    .modal-header h3 {
      margin: 0;
      flex: 1;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      color: #fafafa;
    }

    .modal-close {
      background: none;
      border: none;
      color: #a1a1aa;
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      width: 40px;
      min-width: 40px;
      height: 40px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: #fafafa;
    }

    .modal-body {
      padding: 20px;
    }

    .modal-body table {
      font-size: 0.85rem;
    }

    #modalTable {
      background: #161618;
      border: 1px solid #27272a;
      border-radius: 8px;
    }

    .modal-body .situacao-badge {
      display: inline-block;
      padding: 4px 6px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .modal-body .situacao-badge.ERRO {
      background: #dc262633;
      color: #dc2626;
    }

    .modal-body .situacao-badge.REJEITADO,
    .modal-body .situacao-badge.DENEGADA {
      background: #B8282833;
      color: #B82828;
    }

    .modal-body .situacao-badge.AUTORIZADO {
      background: #56db6533;
      color: #56db65;
    }

    .modal-body .situacao-badge.CANCELADA,
    .modal-body .situacao-badge.CANCELADO {
      background: #B8282833;
      color: #B82828;
    }

    .modal-body .situacao-badge.EMITIDA_DANFE {
      background: #D9770833;
      color: #D97708;
    }

    .modal-body .situacao-badge.PROCESSANDO,
    .modal-body .situacao-badge.PENDENTE {
      background: #D9770833;
      color: #D97708;
    }

    .btn-lupa {
      margin: 0;
      padding: 6px;
      z-index: 24;
      align-self: unset;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 26px;
      height: 26px;
      max-width: unset;
      min-width: unset;
      max-height: unset;
      min-height: unset;
      background: none;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: #a1a1aa;
      font-size: 1rem;
      line-height: 1;
    }

    .btn-lupa:hover {
      background: #2f2f36;
    }

    .actions-dropdown-wrap {
      position: relative;
      display: inline-block;
    }

    .dropdown-nfe-opcoes {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 4px;
      min-width: 220px;
      background: #1D1D20;
      border: 1px solid #27272A;
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
      z-index: 100;
      padding: 6px 0;
    }

    .dropdown-nfe-opcoes.open {
      display: block;
    }

    .dropdown-nfe-opcoes a,
    .dropdown-nfe-opcoes button {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      padding: 10px 14px;
      border: none;
      background: none;
      color: #fafafa;
      font-size: 0.9rem;
      text-align: left;
      cursor: pointer;
      transition: background 0.15s;
      text-decoration: none;
      border-radius: 0;
    }

    .dropdown-nfe-opcoes a:hover,
    .dropdown-nfe-opcoes button:hover:not(:disabled) {
      background: #27272A;
      text-decoration: none;
      border-radius: 0;
    }

    .dropdown-nfe-opcoes button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .dropdown-nfe-opcoes .dropdown-divider {
      height: 1px;
      background: #27272A;
      margin: 6px 0;
    }

    .dropdown-nfe-opcoes .dropdown-item-icon {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #a1a1aa;
      flex-shrink: 0;
    }

    .dropdown-nfe-opcoes .dropdown-item-icon svg {
      width: 16px;
      height: 16px;
    }

    .modal.modal-chamada {
      max-width: 720px;
    }

    .modal-body pre {
      margin: 0;
      padding: 16px;
      background: #161618;
      border-radius: 8px;
      overflow: auto;
      font-size: 0.8rem;
      line-height: 1.4;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .modal-footer {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid #27272A;
      background: #161618;
    }

    button.secondary {
      background: #27272A;
      color: #fafafa;
      padding: 10px 12px;
      font-size: 14px;
      max-height: 40px;
      min-height: 40px;
    }

    button.secondary:hover {
      background: #3f3f46;
    }

    button.secondary:disabled {
      background: #27272A;
      color: #71717a;
      cursor: not-allowed;
    }

    .form-group.has-error input,
    .form-group.has-error select {
      border-color: #f87171;
    }

    .form-group .error-msg {
      font-size: 0.8rem;
      color: #fca5a5;
      margin-top: 2px;
    }

    input[type="text"] {
      min-width: 200px;
      height: 40px;
      padding: 0 12px;
      border: 1px solid #27272A;
      border-radius: 8px;
      background: #1D1D20;
      color: #fafafa;
      font-size: 14px;
    }

    input[type="text"]:focus,
    input[type="email"]:focus {
      outline: none;
      border-color: #D7A404;
      box-shadow: 0 0 0 3px #D7A40414;
    }

    input[type="email"] {
      min-width: 200px;
      height: 40px;
      padding: 0 12px;
      border: 1px solid #27272A;
      border-radius: 8px;
      background: #161618;
      color: #fafafa;
      font-size: 0.95rem;
    }

    .form-group-datetime input,
    .form-group-datetime .form-datetime-alt {
      min-width: 200px;
      height: 40px;
      padding: 0 40px 0 12px;
      border: 1px solid #27272A;
      border-radius: 8px;
      background: #161618 url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23a1a1aa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E") no-repeat right 10px center;
      color: #fafafa;
      font-family: inherit;
      font-size: 0.95rem;
      font-weight: 400;
      cursor: pointer;
    }

    .form-group-datetime input:focus {
      outline: none;
      border-color: #D7A404;
      box-shadow: 0 0 0 3px #D7A40414;
    }

    .form-group-datetime {
      position: relative;
    }

    .form-section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #27272A;
    }

    .form-section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .form-section-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: #fafafa;
      margin: 0 0 12px 0;
      padding-bottom: 0;
    }

    .form-section-subtitle {
      font-size: 0.85rem;
      font-weight: 600;
      color: #a1a1aa;
      margin: 16px 0 10px 0;
    }

    .form-section-subtitle:first-of-type {
      margin-top: 0;
    }

    .form-grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 16px;
    }

    @media (max-width: 640px) {
      .form-grid-2 {
        grid-template-columns: 1fr;
      }
    }

    .form-section .form-group {
      min-width: 0;
    }

    .form-section .form-group label {
      font-size: 14px;
    }

    .form-section input,
    .form-section select {
      width: 100%;
      min-width: 0;
      height: 40px;
      padding: 0 12px;
    }

    .modal.modal-nf-full {
      width: 600px;
      max-width: calc(100vw - 24px);
      max-height: 90vh;
    }

    .modal.modal-nf-full .modal-body {
      max-height: calc(90vh - 120px);
    }

    .nf-items-table {
      width: 100%;
      font-size: 0.8rem;
    }

    .nf-items-table th {
      color: #a1a1aa;
      font-weight: 500;
      padding: 8px 6px;
      white-space: nowrap;
    }

    .nf-items-table td {
      padding: 6px;
    }

    .nf-items-table input {
      width: 100%;
      min-width: 60px;
      height: 40px;
      padding: 0 8px;
      font-size: 0.85rem;
      box-sizing: border-box;
    }

    .nf-items-table input[type="number"] {
      height: 40px;
      padding: 0 8px;
      appearance: textfield;
      -moz-appearance: textfield;
    }

    .nf-items-table input[type="number"]::-webkit-outer-spin-button,
    .nf-items-table input[type="number"]::-webkit-inner-spin-button {
      appearance: none;
      -webkit-appearance: none;
      margin: 0;
    }

    .nf-items-table .col-desc {
      width: 240px;
      max-width: 240px;
    }

    .nf-items-table td.col-desc {
      width: 240px;
      max-width: 240px;
    }

    .nf-items-table .col-ncm {
      width: 140px;
      max-width: 140px;
    }

    .nf-items-table td.col-ncm {
      width: 140px;
      max-width: 140px;
    }

    .nf-items-table .col-num {
      width: 70px;
    }

    .nf-items-table .col-item-num {
      max-width: 40px;
      width: 40px;
      white-space: nowrap;
    }

    .nf-items-table .col-del {
      width: 70px;
      text-align: center;
    }

    .nf-items-table .col-del-btns {
      display: inline-flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: 4px;
      white-space: nowrap;
    }

    .btn-icon {
      background: none;
      border: none;
      color: #fafafa;
      cursor: pointer;
      padding: 4px;
      font-size: 1rem;
      line-height: 1;
    }

    .btn-icon:hover {
      color: #f87171;
    }

    textarea {
      width: 100%;
      min-height: 100px;
      padding: 10px 12px;
      border: 1px solid #27272A;
      border-radius: 8px;
      background: #161618;
      color: #fafafa;
      font-size: 0.95rem;
      font-family: inherit;
    }

    textarea:focus {
      outline: none;
      border-color: #D7A404;
      box-shadow: 0 0 0 3px #D7A40414;
    }

    .form-grid-4 {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px 16px;
    }

    @media (max-width: 768px) {
      .form-grid-4 {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .form-grid-4 {
        grid-template-columns: 1fr;
      }
    }

    .calc-imposto-header {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 16px;
      flex-wrap: unset;
      gap: 24px;
      align-items: center;
    }

    .calc-imposto-header .form-section-title {
      flex-shrink: 0;
    }

    .calc-imposto-toggle-group {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }

    .calc-imposto-toggle-group span {
      font-size: 0.85rem;
      color: #a1a1aa;
    }

    #calcImpostoInputs input.calc-auto-readonly {
      background-color: #27272A !important;
      color: #a1a1aa;
      cursor: not-allowed;
    }

    .toggle-wrap {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: #27272A;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .toggle-switch.on {
      background: #22c55e;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: #fafafa;
      border-radius: 50%;
      transition: transform 0.2s;
    }

    .toggle-switch.on::after {
      transform: translateX(20px);
    }

    .label-with-info {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .label-with-info .info-icon {
      color: #38bdf8;
      font-size: 0.9rem;
      cursor: help;
    }

    .nf-produto-ac-wrap {
      position: relative;
    }

    .nf-produto-ac-list {
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      margin: 0;
      padding: 0;
      list-style: none;
      background: #1D1D20;
      border: 1px solid #27272A;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 50;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .nf-produto-ac-list li {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 0.85rem;
      color: #fafafa;
      border-bottom: 1px solid #27272A;
    }

    .nf-produto-ac-list li:last-child {
      border-bottom: none;
    }

    .nf-produto-ac-list li:hover {
      background: #27272A;
    }

    .btn-icon-lucide {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-icon-lucide [data-lucide] {
      width: 16px;
      height: 16px;
    }

    .btn-sync.btn-icon-lucide [data-lucide] {
      width: 16px;
      height: 16px;
    }

    .modal-close [data-lucide] {
      width: 20px;
      height: 20px;
    }

    .sheet-panel.sheet-cliente {
      width: 600px;
      max-width: 100vw;
    }

    .sheet-cliente .sheet-header {
      height: 56px;
      padding: 16px 24px;
    }

    .sheet-cliente .sheet-header h3 {
      font-size: 14px;
      font-weight: 500;
    }

    .sheet-cliente .form-grid-paired {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px 16px;
    }

    @media (max-width: 600px) {
      .sheet-cliente .form-grid-paired {
        grid-template-columns: 1fr;
      }
    }

    .sheet-cliente .form-section-title {
      font-size: 16px;
      color: #fafafa;
      margin: 0 0 12px 0;
      padding-top: 12px;
      border-top: 1px solid #27272A;
    }

    .sheet-cliente .form-section:first-child .form-section-title {
      padding-top: 0;
      border-top: none;
    }

    .input-with-icon {
      position: relative;
      display: flex;
    }

    .input-with-icon input {
      flex: 1;
      padding-right: 40px;
    }

    .input-with-icon .input-icon-btn {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: #a1a1aa;
      cursor: pointer;
      padding: 4px;
    }

    .input-with-icon .input-icon-btn:hover {
      color: #fafafa;
    }

    .input-with-icon .input-icon-btn [data-lucide] {
      width: 18px;
      height: 18px;
    }

    .cliente-search-wrap {
      position: relative;
      display: flex;
      align-items: stretch;
    }

    .cliente-search-wrap input {
      flex: 1;
      border-top-right-radius: 0;
      border-bottom-right-radius: 0;
      padding-right: 12px;
    }

    .cliente-search-wrap .cliente-btn-add-edit {
      width: 40px;
      min-width: 40px;
      min-height: 40px;
      padding: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #27272A;
      border: 1px solid #27272A;
      border-left: none;
      border-radius: 0 8px 8px 0;
      color: #a1a1aa;
      cursor: pointer;
    }

    .cliente-search-wrap .cliente-btn-add-edit:hover {
      background: #3f3f46;
      color: #fafafa;
    }

    .cliente-search-wrap .cliente-btn-add-edit [data-lucide] {
      width: 18px;
      height: 18px;
    }

    .cliente-contatos-list {
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      margin: 0;
      padding: 0;
      list-style: none;
      background: #1D1D20;
      border: 1px solid #27272A;
      border-radius: 8px;
      margin-top: 4px;
      max-height: 220px;
      overflow-y: auto;
      z-index: 50;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .cliente-contatos-list li {
      padding: 10px 12px;
      cursor: pointer;
      font-size: 0.9rem;
      color: #fafafa;
      border-bottom: 1px solid #27272A;
      line-height: 1.35;
    }

    .cliente-contatos-list li:last-child {
      border-bottom: none;
    }

    .cliente-contatos-list li:hover {
      background: #27272A;
    }

    .cliente-contatos-list .contato-nome {
      display: block;
      font-weight: 500;
    }

    .cliente-contatos-list .contato-doc {
      display: block;
      font-size: 0.8rem;
      color: #a1a1aa;
      margin-top: 2px;
    }

    .cliente-endereco-section {
      margin-top: 16px;
    }

    .cliente-endereco-section .form-section-title {
      margin-bottom: 12px;
    }

    .cliente-endereco-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    @media (max-width: 520px) {
      .cliente-endereco-cards {
        grid-template-columns: 1fr;
      }
    }

    .cliente-endereco-card {
      background: #161618;
      border: 1px solid #27272A;
      border-radius: 8px;
      overflow: hidden;
      min-height: 140px;
      display: flex;
      flex-direction: column;
    }

    .cliente-endereco-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: #27272A;
      color: #fafafa;
      font-size: 14px;
      font-weight: 500;
      height: 40px;
    }

    .cliente-endereco-card-header .btn-edit-endereco {
      background: none;
      border: none;
      color: #a1a1aa;
      cursor: pointer;
      padding: 0;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      max-height: 24px;
    }

    .cliente-endereco-card-header .btn-edit-endereco:hover {
      background: #3f3f46;
      color: #fafafa;
    }

    .cliente-endereco-card-header .btn-edit-endereco [data-lucide] {
      width: 14px;
      height: 14px;
    }

    .cliente-endereco-card-add {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      min-height: 140px;
      cursor: pointer;
      background: #161618;
      border: 1px solid #27272a;
      border-radius: 12px;
      color: #a1a1aa;
      transition: background 0.2s, border-color 0.2s, color 0.2s;
    }

    .cliente-endereco-card-add:hover {
      background: #1D1D20;
      border-color: #52525b;
      color: #fafafa;
    }

    .cliente-endereco-card-add .cliente-endereco-card-add-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #27272A;
      color: #fafafa;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .cliente-endereco-card-add:hover .cliente-endereco-card-add-icon {
      background: #3f3f46;
    }

    .cliente-endereco-card-add .cliente-endereco-card-add-icon [data-lucide] {
      width: 20px;
      height: 20px;
    }

    .cliente-endereco-card-add .cliente-endereco-card-add-label {
      font-size: 14px;
      font-weight: 500;
    }

    .cliente-endereco-card-body {
      padding: 12px;
      font-size: 0.9rem;
      line-height: 1.5;
      color: #fafafa;
      flex: 1;
      min-height: 0;
      overflow: auto;
    }

    .cliente-endereco-card-body.empty {
      color: #71717a;
      font-style: italic;
    }

    .modal-cliente-view {
      display: none;
    }

    .modal-cliente-view.active {
      display: block;
    }

    .cliente-nome-link {
      cursor: pointer;
      text-decoration: none;
      color: inherit;
    }

    .cliente-nome-link:hover {
      text-decoration: underline;
    }

    .sheet-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.25s, visibility 0.25s;
    }

    .sheet-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .sheet-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 880px;
      max-width: 100vw;
      height: 100vh;
      background: #1D1D20;
      border-left: 1px solid #27272A;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s ease;
      box-shadow: -4px 0 24px rgba(0, 0, 0, 0.3);
    }

    .sheet-overlay.open .sheet-panel {
      transform: translateX(0);
    }

    .sheet-panel .sheet-header,
    .sheet-panel .sheet-footer {
      flex-shrink: 0;
    }

    .sheet-header {
      display: flex;
      align-items: center;
      height: 56px;
      padding: 16px 24px;
      border-bottom: 1px solid #27272A;
    }

    .sheet-header::before {
      content: '';
      width: 40px;
      flex-shrink: 0;
    }

    .sheet-header h3 {
      margin: 0;
      flex: 1;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      color: #fafafa;
    }

    .sheet-header .modal-close {
      width: 40px;
      min-width: 40px;
      height: 40px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .sheet-body {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding: 24px;
      -webkit-overflow-scrolling: touch;
    }

    .sheet-tabs {
      display: flex;
      gap: 0;
      overflow-x: auto;
      margin: 16px 0px;
      padding: 0px;
      border-bottom: 1px solid #27272A;
      flex-wrap: nowrap;
    }

    .sheet-tabs::-webkit-scrollbar {
      height: 4px;
    }

    .sheet-tab {
      padding: 12px 12px;
      margin: 0;
      font-size: 0.85rem;
      color: #a1a1aa;
      background: none;
      border: none;
      cursor: pointer;
      white-space: nowrap;
      border-radius: 0px;
      transition: color 0.2s, background 0.2s;
    }

    .sheet-tab:hover {
      color: #fafafa;
    }

    .sheet-tab.active {
      color: #D7A404;
      font-weight: 500;
      box-shadow: inset 0 -2px 0 0 #D7A404;
    }

    .sheet-tab-content {
      display: none;
    }

    .sheet-tab-content.active {
      display: block;
    }

    .sheet-body .form-section {
      margin: 0;
      padding: 0;
      border: none;
    }

    .sheet-body .form-section+.form-section {
      margin-top: 12px;
    }

    .sheet-footer {
      padding: 16px 24px;
      border-top: 1px solid #27272A;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      background: #161618;
    }

    .form-grid-3 {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px 16px;
    }

    @media (max-width: 600px) {
      .form-grid-3 {
        grid-template-columns: 1fr;
      }
    }

    /* Flatpickr - tema escuro alinhado ao app */
    .flatpickr-calendar {
      width: 264px !important;
      min-width: 264px !important;
      max-width: 264px !important;
      height: 264px !important;
      min-height: 264px !important;
      max-height: 264px !important;
      background: #1D1D20 !important;
      border: 1px solid #27272A !important;
      border-radius: 8px !important;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5) !important;
    }

    .flatpickr-calendar.hasTime {
      height: 264px !important;
      display: flex;
      flex-direction: column;
    }

    .flatpickr-calendar.hasTime .flatpickr-months {
      flex-shrink: 0;
    }

    .flatpickr-calendar.hasTime .flatpickr-days {
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    .flatpickr-calendar.hasTime .flatpickr-time {
      height: 40px;
      flex-shrink: 0;
      background: #1D1D20 !important;
      border: none !important;
      border-top: none !important;
    }

    .flatpickr-months {
      background: #1D1D20 !important;
      position: relative;
    }

    .flatpickr-current-month {
      color: #fafafa !important;
      position: absolute !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      margin: 0 !important;
    }

    .flatpickr-prev-month svg,
    .flatpickr-next-month svg {
      fill: #a1a1aa !important;
    }

    .flatpickr-prev-month:hover svg,
    .flatpickr-next-month:hover svg {
      fill: #fafafa !important;
    }

    .flatpickr-weekdays {
      background: #1D1D20 !important;
    }

    span.flatpickr-weekday {
      color: #a1a1aa !important;
    }

    .flatpickr-days {
      background: #1D1D20 !important;
      border-color: #27272A !important;
    }

    .dayContainer {
      background: #1D1D20 !important;
    }

    .flatpickr-day {
      color: #fafafa !important;
      border-color: transparent !important;
    }

    .flatpickr-day.prevMonthDay,
    .flatpickr-day.nextMonthDay {
      visibility: hidden;
      pointer-events: none;
    }

    .flatpickr-day:hover {
      background: #27272A !important;
      border-color: #27272A !important;
      color: #fafafa !important;
      border-radius: 6px;
    }

    .flatpickr-day.selected,
    .flatpickr-day.startRange,
    .flatpickr-day.endRange {
      background: #27272A !important;
      border-color: #27272A !important;
      color: #fafafa !important;
      border-radius: 6px;
    }

    .flatpickr-day.today {
      border-color: #27272A !important;
    }

    .flatpickr-day.today:hover {
      background: #27272A !important;
      color: #fafafa !important;
    }

    .flatpickr-time {
      background: #1D1D20 !important;
      border: none !important;
      border-top: none !important;
    }

    .flatpickr-time input {
      color: #fafafa !important;
      background: #161618 !important;
      border: 1px solid #27272A !important;
      border-radius: 6px !important;
    }

    .flatpickr-time .flatpickr-time-separator {
      color: #a1a1aa !important;
    }

    .flatpickr-time .numInputWrapper span.arrowUp:after {
      border-bottom-color: #a1a1aa !important;
    }

    .flatpickr-time .numInputWrapper span.arrowDown:after {
      border-top-color: #a1a1aa !important;
    }

    .flatpickr-time .numInputWrapper:hover span.arrowUp:after {
      border-bottom-color: #fafafa !important;
    }

    .flatpickr-time .numInputWrapper:hover span.arrowDown:after {
      border-top-color: #fafafa !important;
    }

    .flatpickr-am-pm {
      background: #161618 !important;
      color: #fafafa !important;
      border: 1px solid #27272A !important;
      border-radius: 6px !important;
    }

    .flatpickr-am-pm:hover {
      background: #27272A !important;
      color: #fafafa !important;
    }

    /* Pagination - invoices list */
    .pagination-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 24px;
      background: #1D1D20;
      width: 100%;
      box-sizing: border-box;
    }
    .pagination-summary {
      font-size: 0.8rem;
      color: #71717a;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .pagination-nav-group {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 2px;
      flex-shrink: 0;
    }
    .pagination-container .btn-page {
      min-width: 32px;
      height: 32px;
      padding: 0 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      border: none;
      background: transparent;
      color: #71717a;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s, color 0.15s;
      font-family: inherit;
      flex-shrink: 0;
    }
    .pagination-container .btn-page:hover {
      color: #fafafa;
      background: #27272A;
    }
    .pagination-container .btn-page.active {
      color: #fafafa;
      background: #3f3f46;
      font-weight: 600;
    }
    .pagination-dots {
      color: #52525b;
      font-size: 0.875rem;
      padding: 0 2px;
      display: inline-flex;
      align-items: center;
      height: 32px;
      cursor: default;
      user-select: none;
      flex-shrink: 0;
    }
    .pagination-container .btn-page-nav {
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      border: 1px solid #27272A;
      background: #1D1D20;
      color: #a1a1aa;
      cursor: pointer;
      transition: background 0.15s, border-color 0.15s, color 0.15s;
      padding: 0;
      flex-shrink: 0;
      font-family: inherit;
    }
    .pagination-container .btn-page-nav:hover:not(:disabled) {
      background: #27272A;
      border-color: #3f3f46;
      color: #fafafa;
    }
    .pagination-container .btn-page-nav:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    .pagination-container .btn-page-nav [data-lucide] {
      width: 14px;
      height: 14px;
    }
    @media (max-width: 480px) {
      .pagination-container {
        flex-direction: column;
        gap: 10px;
        padding: 12px 16px;
        align-items: flex-start;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
  <script src="modal-scroll-lock.js"></script>
</head>

<body>
  <div class="container">
    <div
      style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px; margin-bottom: 24px;">
      <h1 style="margin: 0;">Notas Fiscais de Saída</h1>
      <div style="display: flex; gap: 12px; align-items: center;">
        <button type="button" class="btn-sync btn-icon-lucide" id="btnSync"><i data-lucide="refresh-ccw"></i>
          Sincronizar status</button>
        <button type="button" class="primary btn-icon-lucide" id="btnIncluirNF"><i data-lucide="plus"></i> Incluir nota
          fiscal</button>
      </div>
    </div>

    <div class="invoice-filters-row">
      <div class="invoice-search">
        <label class="sr-only" for="filterPedido">Buscar pelo nº da NF</label>
        <input type="text" id="filterPedido" placeholder="Buscar pelo nº da NF" autocomplete="off">
        <button type="button" id="filterPedidoSearchBtn" aria-label="Buscar notas fiscais">
          <i data-lucide="search"></i>
        </button>
      </div>
      <div class="invoice-filter-select with-prefix-icon" data-filter-dropdown>
        <i data-lucide="circle-plus" class="filter-prefix-icon"></i>
        <label class="sr-only" for="filterStatus">Status</label>
        <select id="filterStatus" data-filter-source>
          <option value="">Status</option>
        </select>
        <input type="hidden" name="filterStatus" class="filter-hidden-input">
        <button type="button" class="filter-dropdown-trigger" data-filter-trigger>
          <span class="filter-dropdown-label">Status</span>
          <span class="filter-dropdown-sep"> | </span>
          <span class="filter-dropdown-value"></span>
        </button>
        <div class="filter-dropdown-menu" data-filter-menu></div>
      </div>
      <div class="invoice-filter-select with-prefix-icon" data-filter-dropdown>
        <i data-lucide="circle-plus" class="filter-prefix-icon"></i>
        <label class="sr-only" for="filterEmpresa">Empresa</label>
        <select id="filterEmpresa" data-filter-source>
          <option value="">Empresa</option>
        </select>
        <input type="hidden" name="filterEmpresa" class="filter-hidden-input">
        <button type="button" class="filter-dropdown-trigger" data-filter-trigger>
          <span class="filter-dropdown-label">Empresa</span>
          <span class="filter-dropdown-sep"> | </span>
          <span class="filter-dropdown-value"></span>
        </button>
        <div class="filter-dropdown-menu" data-filter-menu></div>
      </div>
    </div>

    <div class="card card-table">
      <div id="invoiceList">
        <table class="skeleton-table" id="invoiceListSkeleton">
          <thead>
            <tr>
              <th>Número</th>
              <th>Data emissão</th>
              <th>Nome</th>
              <th>Situação</th>
              <th>Valor (R$)</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <div class="skeleton-bar short"></div>
              </td>
              <td>
                <div class="skeleton-bar medium"></div>
              </td>
              <td>
                <div class="skeleton-bar long"></div>
              </td>
              <td>
                <div class="skeleton-bar medium"></div>
              </td>
              <td>
                <div class="skeleton-bar short"></div>
              </td>
              <td>
                <div class="skeleton-bar short"></div>
              </td>
            </tr>
            <tr>
              <td>
                <div class="skeleton-bar short"></div>
              </td>
              <td>
                <div class="skeleton-bar medium"></div>
              </td>
              <td>
                <div class="skeleton-bar long"></div>
              </td>
              <td>
                <div class="skeleton-bar medium"></div>
              </td>
              <td>
                <div class="skeleton-bar short"></div>
              </td>
              <td>
                <div class="skeleton-bar short"></div>
              </td>
            </tr>
            <tr>
              <td>
                <div class="skeleton-bar short"></div>
              </td>
              <td>
                <div class="skeleton-bar medium"></div>
              </td>
              <td>
                <div class="skeleton-bar long"></div>
              </td>
              <td>
                <div class="skeleton-bar medium"></div>
              </td>
              <td>
                <div class="skeleton-bar short"></div>
              </td>
              <td>
                <div class="skeleton-bar short"></div>
              </td>
            </tr>
            <tr>
              <td>
                <div class="skeleton-bar short"></div>
              </td>
              <td>
                <div class="skeleton-bar medium"></div>
              </td>
              <td>
                <div class="skeleton-bar long"></div>
              </td>
              <td>
                <div class="skeleton-bar medium"></div>
              </td>
              <td>
                <div class="skeleton-bar short"></div>
              </td>
              <td>
                <div class="skeleton-bar short"></div>
              </td>
            </tr>
            <tr>
              <td>
                <div class="skeleton-bar short"></div>
              </td>
              <td>
                <div class="skeleton-bar medium"></div>
              </td>
              <td>
                <div class="skeleton-bar long"></div>
              </td>
              <td>
                <div class="skeleton-bar medium"></div>
              </td>
              <td>
                <div class="skeleton-bar short"></div>
              </td>
              <td>
                <div class="skeleton-bar short"></div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div id="paginationContainer" class="pagination-container"></div>
    </div>
  </div>

  <div class="modal-overlay" id="modalSituacoes">
    <div class="modal">
      <div class="modal-header">
        <h3>Situações NF's</h3>
        <button type="button" class="modal-close" id="modalClose" aria-label="Fechar"><i data-lucide="x"></i></button>
      </div>
      <div class="modal-body">
        <table id="modalTable">
          <thead>
            <tr>
              <th>Data</th>
              <th>Descrição</th>
              <th>Situação</th>
            </tr>
          </thead>
          <tbody id="modalTableBody"></tbody>
        </table>
        <div class="empty" id="modalEmpty" style="display:none;">Nenhuma situação registrada.</div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modalChamada">
    <div class="modal modal-chamada">
      <div class="modal-header">
        <h3>Chamada enviada à API (Focus NFe)</h3>
        <button type="button" class="modal-close" id="modalChamadaClose" aria-label="Fechar"><i
            data-lucide="x"></i></button>
      </div>
      <div class="modal-body">
        <pre id="modalChamadaPre"></pre>
        <div class="empty" id="modalChamadaEmpty" style="display:none;"></div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modalPreviewChamada">
    <div class="modal modal-chamada">
      <div class="modal-header">
        <h3>JSON que será enviado à API (Focus NFe)</h3>
        <button type="button" class="modal-close" id="modalPreviewChamadaClose" aria-label="Fechar"><i
            data-lucide="x"></i></button>
      </div>
      <div class="modal-body">
        <pre id="modalPreviewChamadaPre"></pre>
        <div class="empty" id="modalPreviewChamadaEmpty" style="display:none;"></div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modalAdicionarNF">
    <div class="modal modal-nf-full">
      <div class="modal-header">
        <h3>Nota Fiscal</h3>
        <button type="button" class="modal-close" id="modalAdicionarNFClose" aria-label="Fechar"><i
            data-lucide="x"></i></button>
      </div>
      <div class="modal-body">
        <div id="modalAdicionarNFMessage" class="message" style="display: none; margin-bottom: 16px;"></div>
        <form id="formAdicionarNF" novalidate>
          <div class="form-section">
            <h4 class="form-section-title">Nota Fiscal</h4>
            <div class="form-grid-2">
              <div class="form-group">
                <label for="nf_natureza_operacao">Natureza de operação</label>
                <input type="text" id="nf_natureza_operacao" name="natureza_operacao"
                  placeholder="Ex: Venda de mercadoria">
              </div>
              <div class="form-group form-group-datetime">
                <label for="nf_data_emissao">Data de emissão</label>
                <input type="text" id="nf_data_emissao" name="data_emissao" placeholder="dd/mm/aaaa, hh:mm:ss" readonly
                  title="Clique para selecionar data e hora">
              </div>
              <div class="form-group form-group-datetime">
                <label for="nf_data_entrada_saida">Data entrada/saída</label>
                <input type="text" id="nf_data_entrada_saida" name="data_entrada_saida"
                  placeholder="dd/mm/aaaa, hh:mm:ss" readonly title="Clique para selecionar data e hora">
              </div>
              <div class="form-group">
                <label for="nf_finalidade_emissao">Finalidade</label>
                <input type="text" id="nf_finalidade_emissao" name="finalidade_emissao" placeholder="1">
              </div>
              <div class="form-group">
                <label for="nf_consumidor_final">Consumidor final</label>
                <select id="nf_consumidor_final" name="consumidor_final">
                  <option value="1">Sim</option>
                  <option value="0">Não</option>
                </select>
              </div>
              <div class="form-group">
                <label for="nf_presenca_comprador">Presença comprador</label>
                <select id="nf_presenca_comprador" name="presenca_comprador">
                  <option value="1">Presencial</option>
                  <option value="2" selected>Internet</option>
                  <option value="9">Outros</option>
                </select>
              </div>
              <div class="form-group">
                <label for="nf_local_destino">Local destino</label>
                <select id="nf_local_destino" name="local_destino">
                  <option value="1">1 - Mesma UF</option>
                  <option value="2">2 - Outra UF</option>
                  <option value="3">3 - Exterior</option>
                </select>
              </div>
              <div class="form-group">
                <label for="nf_indicador_ie_dest">Indicador IE destinatário</label>
                <select id="nf_indicador_ie_dest" name="indicador_inscricao_estadual_destinatario">
                  <option value="1">1 - Contribuinte</option>
                  <option value="2">2 - Isento</option>
                  <option value="9">9 - Não contribuinte</option>
                </select>
              </div>
            </div>
          </div>
          <div class="form-section">
            <h4 class="form-section-title">Emitente</h4>
            <div class="form-grid-2">
              <div class="form-group">
                <label for="nf_cnpj_emitente">CNPJ</label>
                <input type="text" id="nf_cnpj_emitente" name="cnpj_emitente" placeholder="Apenas números">
              </div>
              <div class="form-group">
                <label for="nf_nome_emitente">Nome / Razão social</label>
                <input type="text" id="nf_nome_emitente" name="nome_emitente" placeholder="Nome emitente">
              </div>
              <div class="form-group">
                <label for="nf_nome_fantasia_emitente">Nome fantasia</label>
                <input type="text" id="nf_nome_fantasia_emitente" name="nome_fantasia_emitente" placeholder="Opcional">
              </div>
              <div class="form-group">
                <label for="nf_inscricao_estadual_emitente">Inscrição estadual</label>
                <input type="text" id="nf_inscricao_estadual_emitente" name="inscricao_estadual_emitente"
                  placeholder="IE">
              </div>
              <div class="form-group">
                <label for="nf_cep_emitente">CEP</label>
                <input type="text" id="nf_cep_emitente" name="cep_emitente" placeholder="Apenas números">
              </div>
              <div class="form-group">
                <label for="nf_uf_emitente">UF</label>
                <input type="text" id="nf_uf_emitente" name="uf_emitente" placeholder="MG" maxlength="2">
              </div>
              <div class="form-group">
                <label for="nf_municipio_emitente">Município</label>
                <input type="text" id="nf_municipio_emitente" name="municipio_emitente" placeholder="Cidade">
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label for="nf_bairro_emitente">Bairro</label>
                <input type="text" id="nf_bairro_emitente" name="bairro_emitente" placeholder="Bairro">
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label for="nf_logradouro_emitente">Endereço</label>
                <input type="text" id="nf_logradouro_emitente" name="logradouro_emitente" placeholder="Rua, Av.">
              </div>
              <div class="form-group">
                <label for="nf_numero_emitente">Número</label>
                <input type="text" id="nf_numero_emitente" name="numero_emitente" placeholder="Nº">
              </div>
              <div class="form-group">
                <label for="nf_telefone_emitente">Fone/FAX</label>
                <input type="text" id="nf_telefone_emitente" name="telefone_emitente" placeholder="Opcional">
              </div>
            </div>
          </div>
          <div class="form-section">
            <h4 class="form-section-title">Destinatário</h4>
            <div class="form-grid-2">
              <div class="form-group" style="grid-column: 1 / -1;">
                <label for="nf_cliente_busca">Cliente</label>
                <div class="cliente-search-wrap">
                  <input type="text" id="nf_cliente_busca" autocomplete="off" placeholder="Cliente do pedido" readonly>
                  <button type="button" class="cliente-btn-add-edit" id="nf_cliente_btn_add_edit"
                    aria-label="Adicionar cliente"><i data-lucide="plus"></i></button>
                  <ul class="cliente-contatos-list" id="nf_cliente_contatos_list"></ul>
                </div>
              </div>
              <input type="hidden" id="nf_nome_destinatario" name="nome_destinatario">
              <div class="form-group">
                <label for="nf_tipo_pessoa_dest">Tipo de Pessoa</label>
                <select id="nf_tipo_pessoa_dest" name="tipo_pessoa_dest" required>
                  <option value="">Selecionar</option>
                  <option value="pf">Pessoa Física</option>
                  <option value="pj">Pessoa Jurídica</option>
                </select>
              </div>
              <div class="form-group" id="nf_doc_dest_wrap">
                <label for="nf_cpf_cnpj_dest" id="nf_doc_dest_label">CPF ou CNPJ</label>
                <input type="text" id="nf_cpf_cnpj_dest" placeholder="Selecione o tipo de pessoa" maxlength="18">
                <span class="error-msg" id="nf_doc_dest_error" style="display: none;"></span>
              </div>
              <div class="form-group">
                <label for="nf_inscricao_estadual_destinatario">Inscrição estadual</label>
                <input type="text" id="nf_inscricao_estadual_destinatario" name="inscricao_estadual_destinatario"
                  placeholder="ISENTO ou número">
              </div>
              <div class="form-group">
                <label for="nf_cep_destinatario">CEP</label>
                <input type="text" id="nf_cep_destinatario" name="cep_destinatario" placeholder="Apenas números">
              </div>
              <div class="form-group">
                <label for="nf_uf_destinatario">UF</label>
                <input type="text" id="nf_uf_destinatario" name="uf_destinatario" placeholder="UF" maxlength="2">
              </div>
              <div class="form-group">
                <label for="nf_municipio_destinatario">Município</label>
                <input type="text" id="nf_municipio_destinatario" name="municipio_destinatario" placeholder="Cidade">
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label for="nf_bairro_destinatario">Bairro</label>
                <input type="text" id="nf_bairro_destinatario" name="bairro_destinatario" placeholder="Bairro">
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label for="nf_logradouro_destinatario">Endereço</label>
                <input type="text" id="nf_logradouro_destinatario" name="logradouro_destinatario"
                  placeholder="Rua, Av.">
              </div>
              <div class="form-group">
                <label for="nf_numero_destinatario">Número</label>
                <input type="text" id="nf_numero_destinatario" name="numero_destinatario" placeholder="Nº">
              </div>
              <div class="form-group">
                <label for="nf_pais_destinatario">País</label>
                <input type="text" id="nf_pais_destinatario" name="pais_destinatario" placeholder="Brasil">
              </div>
              <div class="form-group">
                <label for="nf_telefone_destinatario">Fone/FAX</label>
                <input type="text" id="nf_telefone_destinatario" name="telefone_destinatario" placeholder="Opcional">
              </div>
            </div>
          </div>
          <div class="form-section">
            <h4 class="form-section-title">Produtos</h4>
            <table class="nf-items-table">
              <thead>
                <tr>
                  <th class="col-num col-item-num"></th>
                  <th class="col-desc">Descrição</th>
                  <th class="col-num">SKU</th>
                  <th class="col-ncm">NCM</th>
                  <th>UN</th>
                  <th class="col-num">Qtd</th>
                  <th class="col-num">Valor un.</th>
                  <th class="col-num">Valor total</th>
                  <th class="col-del"></th>
                </tr>
              </thead>
              <tbody id="nfItemsBody"></tbody>
            </table>
            <button type="button" class="small" id="btnAdicionarItemNF" style="margin-top: 10px;">+ Adicionar
              produto</button>
          </div>
          <div class="form-section">
            <h4 class="form-section-title">Totais</h4>
            <div class="form-grid-2">
              <div class="form-group">
                <label for="nf_valor_produtos">Valor produtos (R$)</label>
                <input type="number" id="nf_valor_produtos" name="valor_produtos" step="0.01" min="0">
              </div>
              <div class="form-group">
                <label for="nf_valor_frete">Valor frete (R$)</label>
                <input type="number" id="nf_valor_frete" name="valor_frete" step="0.01" min="0">
              </div>
              <div class="form-group">
                <label for="nf_valor_desconto">Valor desconto (R$)</label>
                <input type="number" id="nf_valor_desconto" name="valor_desconto" step="0.01" min="0" placeholder="0">
              </div>
              <div class="form-group">
                <label for="nf_valor_total">Valor total (R$)</label>
                <input type="number" id="nf_valor_total" name="valor_total" step="0.01" min="0">
              </div>
            </div>
          </div>
          <div class="form-section" id="formSectionCalcImposto">
            <div class="calc-imposto-header">
              <h4 class="form-section-title" style="margin: 0;">Cálculo de imposto</h4>
              <div class="calc-imposto-toggle-group">
                <span>Cálculo automático ligado</span>
                <div class="toggle-wrap">
                  <div class="toggle-switch on" id="nfCalcAutoToggle" role="switch" aria-checked="true"
                    title="Ativar/desativar cálculo automático"></div>
                  <span id="nfCalcAutoLabel" style="font-size: 0.85rem; color: #a1a1aa;">Ativado</span>
                </div>
              </div>
            </div>
            <div class="form-grid-4" id="calcImpostoInputs">
              <div class="form-group">
                <label for="nf_total_produtos">Total dos Produtos (R$)</label>
                <input type="number" id="nf_total_produtos" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_valor_frete_calc">Valor do Frete (R$)</label>
                <input type="number" id="nf_valor_frete_calc" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_valor_seguro_calc">Valor do Seguro (R$)</label>
                <input type="number" id="nf_valor_seguro_calc" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_outras_despesas">Outras Despesas (R$)</label>
                <input type="number" id="nf_outras_despesas" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_desconto_calc">Desconto (R$)</label>
                <input type="number" id="nf_desconto_calc" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_total_nota">Total da Nota (R$)</label>
                <input type="number" id="nf_total_nota" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_base_icms">Base ICMS</label>
                <input type="number" id="nf_base_icms" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_valor_icms">Valor ICMS</label>
                <input type="number" id="nf_valor_icms" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_base_icms_st">Base ICMS ST</label>
                <input type="number" id="nf_base_icms_st" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_valor_icms_st">Valor ICMS ST</label>
                <input type="number" id="nf_valor_icms_st" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_valor_ipi">Valor IPI</label>
                <input type="number" id="nf_valor_ipi" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_total_is">Total IS (R$)</label>
                <input type="number" id="nf_total_is" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_total_ibs">Total IBS (R$)</label>
                <input type="number" id="nf_total_ibs" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_total_cbs">Total CBS (R$)</label>
                <input type="number" id="nf_total_cbs" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_total_servicos">Total dos Serviços</label>
                <input type="number" id="nf_total_servicos" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_valor_issqn">Valor ISSQN</label>
                <input type="number" id="nf_valor_issqn" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_valor_funrural">Valor Funrural (R$)</label>
                <input type="number" id="nf_valor_funrural" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_total_faturado">Total Faturado (R$)</label>
                <input type="number" id="nf_total_faturado" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_total_tributos" class="label-with-info">Total A. Tributos (R$) <span class="info-icon"
                    title="Valor aproximado dos tributos">&#8505;</span></label>
                <input type="number" id="nf_total_tributos" step="0.01" min="0" placeholder="0,00">
              </div>
            </div>
          </div>
          <div class="form-section">
            <h4 class="form-section-title">Retenções</h4>
            <div class="form-grid-4">
              <div class="form-group">
                <label for="nf_minimo_retencao">Mínimo p/ retenção</label>
                <input type="number" id="nf_minimo_retencao" step="0.01" min="0" value="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_base_retencoes">Base p/ retenções</label>
                <input type="number" id="nf_base_retencoes" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_valor_ir">Valor IR</label>
                <input type="number" id="nf_valor_ir" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_valor_csll">Valor CSLL</label>
                <input type="number" id="nf_valor_csll" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_valor_pis_retido">Valor PIS retido</label>
                <input type="number" id="nf_valor_pis_retido" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_valor_cofins_retido">Valor COFINS retido</label>
                <input type="number" id="nf_valor_cofins_retido" step="0.01" min="0" placeholder="0,00">
              </div>
              <div class="form-group">
                <label for="nf_valor_iss_retido">Valor ISS retido</label>
                <input type="number" id="nf_valor_iss_retido" step="0.01" min="0" placeholder="0,00">
              </div>
            </div>
          </div>
          <div class="form-section">
            <h4 class="form-section-title">Transportador / Volumes</h4>
            <div class="form-grid-2">
              <div class="form-group">
                <label for="nf_transporte">Transporte</label>
                <select id="nf_transporte">
                  <option value="nao">Não haverá transporte</option>
                  <option value="manual">Inserir transportadora manualmente</option>
                </select>
              </div>
              <div class="form-group">
                <label for="nf_frete_por_conta">Frete por conta</label>
                <select id="nf_frete_por_conta">
                  <option value="0">0 - Emitente</option>
                  <option value="1">1 - Destinatário</option>
                  <option value="2">2 - Terceiros</option>
                  <option value="9">9 - Sem frete</option>
                </select>
              </div>
            </div>
            <h5 class="form-section-subtitle">Dados da transportadora</h5>
            <div class="form-grid-2" id="nfTransportadorDados">
              <div class="form-group">
                <label for="nf_transp_nome">Nome</label>
                <div class="nf-produto-ac-wrap">
                  <input type="text" id="nf_transp_nome" placeholder="Razão social" autocomplete="off">
                  <ul class="nf-produto-ac-list" id="nfTranspAcList"></ul>
                </div>
              </div>
              <div class="form-group">
                <label for="nf_transp_uf_veiculo">UF veículo</label>
                <select id="nf_transp_uf_veiculo">
                  <option value="">UF</option>
                  <option value="MG">MG</option>
                  <option value="SP">SP</option>
                  <option value="RJ">RJ</option>
                  <option value="PR">PR</option>
                  <option value="SC">SC</option>
                  <option value="RS">RS</option>
                  <option value="BA">BA</option>
                  <option value="CE">CE</option>
                  <option value="PE">PE</option>
                  <option value="GO">GO</option>
                  <option value="ES">ES</option>
                  <option value="DF">DF</option>
                  <option value="AC">AC</option>
                  <option value="AL">AL</option>
                  <option value="AM">AM</option>
                  <option value="AP">AP</option>
                  <option value="MA">MA</option>
                  <option value="MS">MS</option>
                  <option value="MT">MT</option>
                  <option value="PA">PA</option>
                  <option value="PB">PB</option>
                  <option value="PI">PI</option>
                  <option value="RN">RN</option>
                  <option value="RO">RO</option>
                  <option value="RR">RR</option>
                  <option value="SE">SE</option>
                  <option value="TO">TO</option>
                </select>
              </div>
              <div class="form-group">
                <label for="nf_transp_cnpj_cpf">CNPJ/CPF</label>
                <input type="text" id="nf_transp_cnpj_cpf" placeholder="Apenas números">
              </div>
              <div class="form-group">
                <label for="nf_transp_ie">Inscrição Estadual</label>
                <input type="text" id="nf_transp_ie" placeholder="IE">
              </div>
              <div class="form-group">
                <label for="nf_transp_uf">UF</label>
                <select id="nf_transp_uf">
                  <option value="">UF</option>
                  <option value="MG">MG</option>
                  <option value="SP">SP</option>
                  <option value="RJ">RJ</option>
                  <option value="PR">PR</option>
                  <option value="SC">SC</option>
                  <option value="RS">RS</option>
                  <option value="BA">BA</option>
                  <option value="CE">CE</option>
                  <option value="PE">PE</option>
                  <option value="GO">GO</option>
                  <option value="ES">ES</option>
                  <option value="DF">DF</option>
                  <option value="AC">AC</option>
                  <option value="AL">AL</option>
                  <option value="AM">AM</option>
                  <option value="AP">AP</option>
                  <option value="MA">MA</option>
                  <option value="MS">MS</option>
                  <option value="MT">MT</option>
                  <option value="PA">PA</option>
                  <option value="PB">PB</option>
                  <option value="PI">PI</option>
                  <option value="RN">RN</option>
                  <option value="RO">RO</option>
                  <option value="RR">RR</option>
                  <option value="SE">SE</option>
                  <option value="TO">TO</option>
                </select>
              </div>
              <div class="form-group">
                <label for="nf_transp_municipio">Município</label>
                <input type="text" id="nf_transp_municipio" placeholder="Cidade">
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label for="nf_transp_endereco">Endereço da transportadora</label>
                <input type="text" id="nf_transp_endereco" placeholder="Logradouro, número, bairro">
              </div>
            </div>
            <h5 class="form-section-subtitle">Dados do volume</h5>
            <div class="form-grid-2">
              <div class="form-group">
                <label for="nf_volume_quantidade">Quantidade</label>
                <input type="number" id="nf_volume_quantidade" min="1" value="1" placeholder="1">
              </div>
              <div class="form-group">
                <label for="nf_volume_peso_bruto" class="label-with-info">Peso Bruto <span class="info-icon"
                    title="Em kg">&#8505;</span></label>
                <input type="number" id="nf_volume_peso_bruto" step="0.001" min="0" placeholder="0,000">
              </div>
              <div class="form-group">
                <label for="nf_volume_peso_liquido" class="label-with-info">Peso Líquido <span class="info-icon"
                    title="Em kg">&#8505;</span></label>
                <input type="number" id="nf_volume_peso_liquido" step="0.001" min="0" placeholder="0,000">
              </div>
              <div class="form-group">
                <label for="nf_volume_numeracao">Numeração do volume</label>
                <input type="text" id="nf_volume_numeracao" placeholder="Opcional">
              </div>
              <div class="form-group">
                <label for="nf_volume_marca" class="label-with-info">Marca <span class="info-icon"
                    title="Marca do volume">&#8505;</span></label>
                <input type="text" id="nf_volume_marca" placeholder="Opcional">
              </div>
              <div class="form-group">
                <label for="nf_volume_especie">Espécie</label>
                <select id="nf_volume_especie">
                  <option value="">Selecione uma...</option>
                  <option value="VOLUME">Volume</option>
                  <option value="CAIXA">Caixa</option>
                  <option value="PACOTE">Pacote</option>
                  <option value="OUTROS">Outros</option>
                </select>
              </div>
            </div>
          </div>
          <!-- Seções Pagamento, Categoria e Intermediador removidas a pedido do usuário -->
          <div class="form-section">
            <h4 class="form-section-title">Informações adicionais</h4>
            <div class="form-grid-2">
              <div class="form-group" style="grid-column: 1 / -1;">
                <label for="nf_info_complementares" class="label-with-info">Informações complementares (natureza)
                  Naturezas de operação <span class="info-icon"
                    title="Naturezas de operação">&#8505;</span></label>
                <textarea id="nf_info_complementares" rows="3"
                  placeholder="Informações complementares ao cliente"></textarea>
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label for="nf_info_fisco_natureza" class="label-with-info">Informações adicionais de interesse do fisco
                  (natureza) Naturezas de operação <span class="info-icon"
                    title="Naturezas de operação">&#8505;</span></label>
                <textarea id="nf_info_fisco_natureza" rows="2"
                  placeholder="Informações de interesse do fisco"></textarea>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer" style="display: flex; gap: 10px; align-items: center;">
        <button type="button" class="primary" id="btnEmitirNF">Salvar</button>
      </div>
    </div>
  </div>

  <div class="sheet-overlay" id="sheetCliente">
    <div class="sheet-panel sheet-cliente">
      <div class="sheet-header">
        <h3 style="display: flex; align-items: center; gap: 8px;">
          <span id="sheetClienteTitle">Novo cliente</span>
          <i data-lucide="chevron-down" style="width: 18px; height: 18px; color: #a1a1aa;"></i>
        </h3>
        <button type="button" class="modal-close" id="sheetClienteClose" aria-label="Fechar"><i
            data-lucide="x"></i></button>
      </div>
      <div class="sheet-body">
        <div id="sheetClienteViewForm" class="modal-cliente-view active">
          <form id="formCliente" novalidate>
            <div class="form-section">
              <div class="form-grid-2">
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label for="cliente_nome_fantasia">Nome fantasia</label>
                  <input type="text" id="cliente_nome_fantasia" name="nome_fantasia" placeholder="Nome fantasia">
                </div>
                <div class="form-group">
                  <label for="cliente_tipo_pessoa">Tipo da pessoa</label>
                  <select id="cliente_tipo_pessoa" name="tipo_pessoa">
                    <option value="pj">Pessoa Jurídica</option>
                    <option value="pf">Pessoa Física</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="cliente_cnpj">CNPJ</label>
                  <div class="input-with-icon">
                    <input type="text" id="cliente_cnpj" name="cnpj" placeholder="00.000.000/0000-00">
                    <button type="button" class="input-icon-btn" id="btnClienteBuscarCnpj" aria-label="Buscar"><i
                        data-lucide="search"></i></button>
                  </div>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label for="cliente_razao_social">Razão social</label>
                  <input type="text" id="cliente_razao_social" name="razao_social" placeholder="Razão social">
                </div>
                <div class="form-group">
                  <label for="cliente_tipo_contribuinte">Tipo de contribuinte</label>
                  <select id="cliente_tipo_contribuinte" name="tipo_contribuinte">
                    <option value="1">1 - Contribuinte ICMS</option>
                    <option value="2">2 - Contribuinte isento</option>
                    <option value="9" selected>9 - Não contribuinte</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="cliente_inscricao_estadual">Inscrição estadual</label>
                  <input type="text" id="cliente_inscricao_estadual" name="inscricao_estadual"
                    placeholder="Inscrição estadual">
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label for="cliente_email">Email</label>
                  <input type="email" id="cliente_email" name="email" placeholder="email@exemplo.com">
                </div>
                <div class="form-group">
                  <label for="cliente_telefone_celular">Telefone celular</label>
                  <input type="text" id="cliente_telefone_celular" name="telefone_celular"
                    placeholder="(00) 00000-0000">
                </div>
                <div class="form-group">
                  <label for="cliente_telefone_comercial">Telefone comercial</label>
                  <input type="text" id="cliente_telefone_comercial" name="telefone_comercial"
                    placeholder="(00) 0000-0000">
                </div>
              </div>
            </div>
            <div class="form-section cliente-endereco-section">
              <h4 class="form-section-title">Endereço</h4>
              <div class="cliente-endereco-cards">
                <div class="cliente-endereco-card cliente-endereco-card-add" id="clienteEnderecoCardAdd" role="button"
                  tabindex="0" aria-label="Adicionar endereço" style="display: none;">
                  <div class="cliente-endereco-card-add-icon"><i data-lucide="plus"></i></div>
                  <span class="cliente-endereco-card-add-label">Adicionar endereço</span>
                </div>
                <div class="cliente-endereco-card" data-tipo="comercial">
                  <div class="cliente-endereco-card-header">
                    <span>Comercial</span>
                    <button type="button" class="btn-edit-endereco" data-tipo="comercial" aria-label="Editar"><i
                        data-lucide="pen"></i></button>
                  </div>
                  <div class="cliente-endereco-card-body" id="clienteEnderecoComercialDisplay">Clique em editar para
                    preencher o endereço</div>
                </div>
                <div class="cliente-endereco-card" data-tipo="residencial">
                  <div class="cliente-endereco-card-header">
                    <span>Residencial</span>
                    <button type="button" class="btn-edit-endereco" data-tipo="residencial" aria-label="Editar"><i
                        data-lucide="pen"></i></button>
                  </div>
                  <div class="cliente-endereco-card-body" id="clienteEnderecoResidencialDisplay">Clique em editar para
                    preencher o endereço</div>
                </div>
                <div class="cliente-endereco-card" data-tipo="entrega">
                  <div class="cliente-endereco-card-header">
                    <span>Entrega</span>
                    <button type="button" class="btn-edit-endereco" data-tipo="entrega" aria-label="Editar"><i
                        data-lucide="pen"></i></button>
                  </div>
                  <div class="cliente-endereco-card-body" id="clienteEnderecoEntregaDisplay">Clique em editar para
                    preencher o endereço</div>
                </div>
                <div class="cliente-endereco-card" data-tipo="nota_fiscal">
                  <div class="cliente-endereco-card-header">
                    <span>Nota Fiscal</span>
                    <button type="button" class="btn-edit-endereco" data-tipo="nota_fiscal" aria-label="Editar"><i
                        data-lucide="pen"></i></button>
                  </div>
                  <div class="cliente-endereco-card-body" id="clienteEnderecoNotaFiscalDisplay">Clique em editar para
                    preencher o endereço</div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div id="sheetClienteViewEndereco" class="modal-cliente-view">
          <form id="formClienteEndereco" novalidate>
            <input type="hidden" id="cliente_endereco_tipo" value="entrega">
            <div class="form-section">
              <div class="form-grid-2">
                <div class="form-group">
                  <label for="cliente_end_tipo">Tipo</label>
                  <select id="cliente_end_tipo" name="tipo">
                    <option value="comercial">Comercial</option>
                    <option value="residencial">Residencial</option>
                    <option value="entrega">Entrega</option>
                    <option value="nota_fiscal">Nota Fiscal</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="cliente_end_cep">CEP</label>
                  <input type="text" id="cliente_end_cep" name="cep" placeholder="00000-000">
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label for="cliente_end_rua">Rua</label>
                  <input type="text" id="cliente_end_rua" name="rua" placeholder="Rua">
                </div>
                <div class="form-group">
                  <label for="cliente_end_numero">Número</label>
                  <input type="text" id="cliente_end_numero" name="numero" placeholder="Nº">
                </div>
                <div class="form-group">
                  <label for="cliente_end_complemento">Complemento</label>
                  <input type="text" id="cliente_end_complemento" name="complemento" placeholder="Complemento">
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label for="cliente_end_bairro">Bairro</label>
                  <input type="text" id="cliente_end_bairro" name="bairro" placeholder="Bairro">
                </div>
                <div class="form-group">
                  <label for="cliente_end_cidade">Cidade</label>
                  <input type="text" id="cliente_end_cidade" name="cidade" placeholder="Cidade">
                </div>
                <div class="form-group">
                  <label for="cliente_end_uf">UF</label>
                  <select id="cliente_end_uf" name="uf">
                    <option value="">UF</option>
                    <option value="AC">AC</option>
                    <option value="AL">AL</option>
                    <option value="AM">AM</option>
                    <option value="AP">AP</option>
                    <option value="BA">BA</option>
                    <option value="CE">CE</option>
                    <option value="DF">DF</option>
                    <option value="ES">ES</option>
                    <option value="GO">GO</option>
                    <option value="MA">MA</option>
                    <option value="MG">MG</option>
                    <option value="MS">MS</option>
                    <option value="MT">MT</option>
                    <option value="PA">PA</option>
                    <option value="PB">PB</option>
                    <option value="PE">PE</option>
                    <option value="PI">PI</option>
                    <option value="PR">PR</option>
                    <option value="RJ">RJ</option>
                    <option value="RN">RN</option>
                    <option value="RO">RO</option>
                    <option value="RR">RR</option>
                    <option value="RS">RS</option>
                    <option value="SC">SC</option>
                    <option value="SE">SE</option>
                    <option value="SP">SP</option>
                    <option value="TO">TO</option>
                  </select>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
      <div class="sheet-footer" id="sheetClienteFooterForm">
        <button type="button" class="secondary" id="btnClienteCancelar">Cancelar</button>
        <button type="button" class="primary" id="btnClienteSalvar">Salvar contato</button>
      </div>
      <div class="sheet-footer" id="sheetClienteFooterEndereco" style="display: none;">
        <button type="button" class="secondary" id="btnClienteEnderecoVoltar">Voltar</button>
        <button type="button" class="primary" id="btnClienteEnderecoSalvar">Salvar</button>
      </div>
    </div>
  </div>

  <div class="sheet-overlay" id="sheetItemNF">
    <div class="sheet-panel">
      <div class="sheet-header">
        <h3>Item da nota fiscal</h3>
        <button type="button" class="modal-close" id="sheetItemNFClose" aria-label="Fechar"><i
            data-lucide="x"></i></button>
      </div>
      <div class="sheet-body">
        <div class="form-section" style="border: none; padding: 0; margin: 0;">
          <div class="form-grid-2">
            <div class="form-group" style="grid-column: 1 / -1;">
              <label>Descrição</label>
              <input type="text" id="sheet_descricao" data-field="descricao" placeholder="Descrição do produto">
            </div>
            <div class="form-group">
              <label>SKU</label>
              <input type="text" id="sheet_codigo_produto" data-field="codigo_produto" placeholder="SKU do produto">
            </div>
            <div class="form-group">
              <label>Tipo</label>
              <input type="text" id="sheet_tipo" data-field="tipo" placeholder="Produto, Serviço, HILLSONG...">
            </div>
          </div>
        </div>
        <div class="sheet-tabs" id="sheetTabs">
          <button type="button" class="sheet-tab active" data-tab="dados">Dados do item</button>
          <button type="button" class="sheet-tab" data-tab="icms">ICMS</button>
          <button type="button" class="sheet-tab" data-tab="ipi">IPI</button>
          <button type="button" class="sheet-tab" data-tab="pis">PIS/COFINS</button>
          <button type="button" class="sheet-tab" data-tab="importacao">Importação</button>
          <button type="button" class="sheet-tab" data-tab="outros">Outros</button>
          <button type="button" class="sheet-tab" data-tab="estoque">Estoque</button>
          <button type="button" class="sheet-tab" data-tab="retencoes">Retenções</button>
          <button type="button" class="sheet-tab" data-tab="is">IS</button>
          <button type="button" class="sheet-tab" data-tab="ibs">IBS</button>
          <button type="button" class="sheet-tab" data-tab="cbs">CBS</button>
        </div>
        <div id="sheetTabDados" class="sheet-tab-content active">
          <div class="form-section">
            <div class="form-grid-2">
              <div class="form-group">
                <label>Quantidade</label>
                <input type="number" id="sheet_quantidade_comercial" data-field="quantidade_comercial" step="0.01"
                  min="0">
              </div>
              <div class="form-group">
                <label>Unidade</label>
                <input type="text" id="sheet_unidade_comercial" data-field="unidade_comercial" placeholder="UN">
              </div>
              <div class="form-group">
                <label>Valor Unitário</label>
                <input type="number" id="sheet_valor_unitario_comercial" data-field="valor_unitario_comercial"
                  step="0.01" min="0">
              </div>
              <div class="form-group">
                <label>Valor Total</label>
                <input type="number" id="sheet_valor_bruto" data-field="valor_bruto" step="0.01" min="0" readonly>
              </div>
              <div class="form-group">
                <label>Valor Frete</label>
                <input type="number" id="sheet_valor_frete" data-field="valor_frete" step="0.01" min="0" value="0">
              </div>
              <div class="form-group">
                <label>Valor Desconto</label>
                <input type="number" id="sheet_valor_desconto" data-field="valor_desconto" step="0.01" min="0"
                  value="0">
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Natureza da Operação</label>
                <input type="text" id="sheet_natureza" data-field="natureza" placeholder="Ex: Venda de Mercadoria">
              </div>
              <div class="form-group">
                <label>CFOP</label>
                <input type="text" id="sheet_cfop" data-field="cfop" placeholder="6108" maxlength="4">
              </div>
              <div class="form-group">
                <label>NCM</label>
                <input type="text" id="sheet_codigo_ncm" data-field="codigo_ncm" placeholder="39205100" maxlength="8">
              </div>
              <div class="form-group">
                <label>CEST</label>
                <input type="text" id="sheet_cest" data-field="cest" placeholder="Opcional">
              </div>
              <div class="form-group">
                <label>GTIN/EAN</label>
                <input type="text" id="sheet_gtin" data-field="codigo_barras_comercial" placeholder="SEM GTIN">
              </div>
              <div class="form-group">
                <label>GTIN/EAN tributário</label>
                <input type="text" id="sheet_gtin_trib" data-field="codigo_barras_tributavel" placeholder="SEM GTIN">
              </div>
              <div class="form-group">
                <label>Peso Bruto (kg)</label>
                <input type="number" id="sheet_peso_bruto" data-field="peso_bruto" step="0.001" min="0" value="0">
              </div>
              <div class="form-group">
                <label>Peso Líquido (kg)</label>
                <input type="number" id="sheet_peso_liquido" data-field="peso_liquido" step="0.001" min="0" value="0">
              </div>
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Informações complementares do item</label>
                <textarea id="sheet_info_complementares" data-field="info_complementares" rows="8"
                  placeholder="Informações complementares"></textarea>
              </div>
            </div>
          </div>
        </div>
        <div id="sheetTabIcms" class="sheet-tab-content">
          <div class="form-section">
            <div class="form-grid-2">
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Situação tributária do ICMS</label>
                <select id="sheet_icms_situacao_tributaria" data-field="icms_situacao_tributaria">
                  <option value="00">00 - Tributada integralmente</option>
                  <option value="10">10 - Tributada com ST</option>
                  <option value="20">20 - Tributada com redução BC</option>
                  <option value="40">40 - Isenta</option>
                  <option value="41">41 - Não tributada</option>
                  <option value="50">50 - Suspensão</option>
                  <option value="51">51 - Diferimento</option>
                  <option value="60">60 - Cobrado anteriormente por ST</option>
                  <option value="70">70 - Tributada com redução BC e ST</option>
                  <option value="90">90 - Outras</option>
                  <option value="400">400 - Não tributada (Simples Nacional)</option>
                </select>
              </div>
              <div class="form-group">
                <label>Origem</label>
                <select id="sheet_icms_origem" data-field="icms_origem">
                  <option value="0">0 - Nacional</option>
                  <option value="1">1 - Estrangeira (importação direta)</option>
                  <option value="2">2 - Estrangeira (mercado interno)</option>
                  <option value="3">3 - Nacional 40%+ conteúdo estrangeiro</option>
                  <option value="4">4 - Nacional processos básicos</option>
                  <option value="5">5 - Nacional &lt;40% conteúdo estrangeiro</option>
                  <option value="6">6 - Estrangeira sem similar</option>
                  <option value="7">7 - Estrangeira mercado interno sem similar</option>
                </select>
              </div>
              <div class="form-group">
                <label>Modalidade BC ICMS</label>
                <select id="sheet_icms_modalidade_bc" data-field="icms_modalidade_base_calculo">
                  <option value="0">Margem valor agregado</option>
                  <option value="1">Pauta</option>
                  <option value="2">Valor operação</option>
                  <option value="3">Valor da operação</option>
                </select>
              </div>
              <div class="form-group">
                <label>% ICMS</label>
                <input type="number" id="sheet_icms_aliquota" data-field="icms_aliquota" step="0.01" min="0" value="0">
              </div>
              <div class="form-group">
                <label>Valor ICMS</label>
                <input type="number" id="sheet_icms_valor" data-field="icms_valor" step="0.01" min="0" value="0">
              </div>
            </div>
          </div>
        </div>
        <div id="sheetTabIpi" class="sheet-tab-content">
          <div class="form-section">
            <div class="form-grid-2">
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Situação tributária do IPI</label>
                <select id="sheet_ipi_situacao_tributaria" data-field="ipi_situacao_tributaria">
                  <option value="50">50 - Saída tributada</option>
                  <option value="51">51 - Saída tributária com alíquota zero</option>
                  <option value="52">52 - Saída isenta</option>
                  <option value="53">53 - Saída não-tributada</option>
                  <option value="54">54 - Saída imune</option>
                  <option value="55">55 - Saída com suspensão</option>
                  <option value="99">99 - Outras</option>
                </select>
              </div>
              <div class="form-group">
                <label>Cód. Enquadramento IPI</label>
                <input type="text" id="sheet_ipi_codigo_enquadramento" data-field="ipi_codigo_enquadramento_legal"
                  placeholder="999">
              </div>
              <div class="form-group">
                <label>Valor IPI</label>
                <input type="number" id="sheet_ipi_valor" data-field="ipi_valor" step="0.01" min="0" value="0">
              </div>
            </div>
          </div>
        </div>
        <div id="sheetTabPis" class="sheet-tab-content">
          <div class="form-section">
            <h5 class="form-section-subtitle">PIS</h5>
            <div class="form-grid-2">
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Situação tributária do PIS</label>
                <select id="sheet_pis_situacao_tributaria" data-field="pis_situacao_tributaria">
                  <option value="01">01 - Operação tributável (alíquota normal)</option>
                  <option value="02">02 - Operação tributável (alíquota diferenciada)</option>
                  <option value="05">05 - Operação tributável (ST)</option>
                  <option value="06">06 - Operação tributável (alíquota zero)</option>
                  <option value="07">07 - Operação isenta</option>
                  <option value="08">08 - Operação sem incidência</option>
                  <option value="09">09 - Operação com suspensão</option>
                  <option value="49">49 - Outras</option>
                </select>
              </div>
              <div class="form-group">
                <label>% Base PIS</label>
                <input type="number" id="sheet_pis_base" data-field="pis_base_calculo" step="0.01" min="0"
                  value="100.0000">
              </div>
              <div class="form-group">
                <label>Alíq. PIS %</label>
                <input type="number" id="sheet_pis_aliquota" data-field="pis_aliquota_porcentual" step="0.01" min="0"
                  value="0">
              </div>
              <div class="form-group">
                <label>Valor PIS</label>
                <input type="number" id="sheet_pis_valor" data-field="pis_valor" step="0.01" min="0" value="0" readonly>
              </div>
            </div>
            <h5 class="form-section-subtitle">COFINS</h5>
            <div class="form-grid-2">
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>Situação tributária do COFINS</label>
                <select id="sheet_cofins_situacao_tributaria" data-field="cofins_situacao_tributaria">
                  <option value="01">01 - Operação tributável (alíquota normal)</option>
                  <option value="02">02 - Operação tributável (alíquota diferenciada)</option>
                  <option value="05">05 - Operação tributável (ST)</option>
                  <option value="06">06 - Operação tributável (alíquota zero)</option>
                  <option value="07">07 - Operação isenta</option>
                  <option value="08">08 - Operação sem incidência</option>
                  <option value="09">09 - Operação com suspensão</option>
                  <option value="49">49 - Outras</option>
                </select>
              </div>
              <div class="form-group">
                <label>% Base COFINS</label>
                <input type="number" id="sheet_cofins_base" data-field="cofins_base_calculo" step="0.01" min="0"
                  value="100.0000">
              </div>
              <div class="form-group">
                <label>Alíq. COFINS %</label>
                <input type="number" id="sheet_cofins_aliquota" data-field="cofins_aliquota_porcentual" step="0.01"
                  min="0" value="0">
              </div>
              <div class="form-group">
                <label>Valor COFINS</label>
                <input type="number" id="sheet_cofins_valor" data-field="cofins_valor" step="0.01" min="0" value="0"
                  readonly>
              </div>
            </div>
          </div>
        </div>
        <div id="sheetTabImportacao" class="sheet-tab-content">
          <div class="form-section">
            <div class="form-group">
              <label>Situação</label>
              <select id="sheet_importacao_situacao" data-field="importacao_situacao">
                <option value="Não tributado">Não tributado</option>
                <option value="Tributado">Tributado</option>
              </select>
            </div>
          </div>
        </div>
        <div id="sheetTabOutros" class="sheet-tab-content">
          <div class="form-section">
            <div class="form-grid-2">
              <div class="form-group">
                <label>Unidade tributária</label>
                <input type="text" id="sheet_unidade_tributavel" data-field="unidade_tributavel" placeholder="UN">
              </div>
              <div class="form-group">
                <label>Quantidade tributária</label>
                <input type="number" id="sheet_quantidade_tributavel" data-field="quantidade_tributavel" step="0.01"
                  min="0" value="0">
              </div>
              <div class="form-group">
                <label>Valor unitário tributário</label>
                <input type="number" id="sheet_valor_unitario_tributavel" data-field="valor_unitario_tributavel"
                  step="0.0000000001" min="0" value="0">
              </div>
            </div>
          </div>
        </div>
        <div id="sheetTabEstoque" class="sheet-tab-content">
          <div class="form-section">
            <div class="form-grid-2">
              <div class="form-group">
                <label>Código no fornecedor</label>
                <input type="text" id="sheet_codigo_fornecedor" data-field="codigo_fornecedor" placeholder="Opcional">
              </div>
              <div class="form-group">
                <label>Indicador de escala relevante</label>
                <select id="sheet_escala_relevante" data-field="escala_relevante">
                  <option value="S">S - Produzido em Escala Relevante</option>
                  <option value="N">N - Produzido em Escala Não Relevante</option>
                </select>
              </div>
              <div class="form-group">
                <label>Número do lote</label>
                <input type="text" id="sheet_numero_lote" data-field="numero_lote" placeholder="Opcional">
              </div>
              <div class="form-group">
                <label>Data de fabricação</label>
                <input type="text" id="sheet_data_fabricacao" data-field="data_fabricacao" placeholder="YYYY-MM-DD">
              </div>
              <div class="form-group">
                <label>Data de validade</label>
                <input type="text" id="sheet_data_validade" data-field="data_validade" placeholder="YYYY-MM-DD">
              </div>
            </div>
          </div>
        </div>
        <div id="sheetTabRetencoes" class="sheet-tab-content">
          <div class="form-section">
            <div class="form-grid-2">
              <div class="form-group">
                <label>Reter CSRF</label>
                <select id="sheet_reter_csrf" data-field="reter_csrf">
                  <option value="Não">Não</option>
                  <option value="Sim">Sim</option>
                </select>
              </div>
              <div class="form-group">
                <label>Reter IR</label>
                <select id="sheet_reter_ir" data-field="reter_ir">
                  <option value="Não">Não</option>
                  <option value="Sim">Sim</option>
                </select>
              </div>
            </div>
          </div>
        </div>
        <div id="sheetTabIs" class="sheet-tab-content">
          <div class="form-section">
            <p style="font-size: 0.85rem; color: #a1a1aa;">IS aguardando definições. Os campos de IS estão aguardando
              publicação oficial.</p>
          </div>
        </div>
        <div id="sheetTabIbs" class="sheet-tab-content">
          <div class="form-section">
            <div class="form-grid-2">
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>CST IBS</label>
                <input type="text" id="sheet_ibs_cst" data-field="ibs_cbs_situacao_tributaria" placeholder="000">
              </div>
              <div class="form-group">
                <label>Valor Base IBS</label>
                <input type="number" id="sheet_ibs_base" data-field="ibs_cbs_base_calculo" step="0.01" min="0"
                  value="0">
              </div>
              <div class="form-group">
                <label>Alíq. IBS/UF</label>
                <input type="number" id="sheet_ibs_uf_aliquota" data-field="ibs_uf_aliquota" step="0.01" min="0"
                  value="0">
              </div>
              <div class="form-group">
                <label>Valor IBS/UF</label>
                <input type="number" id="sheet_ibs_uf_valor" data-field="ibs_uf_valor" step="0.01" min="0" value="0">
              </div>
            </div>
          </div>
        </div>
        <div id="sheetTabCbs" class="sheet-tab-content">
          <div class="form-section">
            <div class="form-grid-2">
              <div class="form-group" style="grid-column: 1 / -1;">
                <label>CST CBS</label>
                <input type="text" id="sheet_cbs_cst" data-field="cbs_cst" placeholder="000">
              </div>
              <div class="form-group">
                <label>Alíq. CBS</label>
                <input type="number" id="sheet_cbs_aliquota" data-field="cbs_aliquota" step="0.01" min="0" value="0">
              </div>
              <div class="form-group">
                <label>Valor CBS</label>
                <input type="number" id="sheet_cbs_valor" data-field="cbs_valor" step="0.01" min="0" value="0">
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="sheet-footer">
        <button type="button" class="secondary" id="sheetItemNFCancel">Cancelar</button>
        <button type="button" class="primary" id="sheetItemNFSave">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    const API = ''; // same origin

    function showMessage(elId, text, type) {
      const el = document.getElementById(elId);
      el.textContent = text;
      el.className = 'message ' + (type || 'info');
      el.style.display = 'block';
    }

    function openModalSituacoes(invoiceId) {
      const overlay = document.getElementById('modalSituacoes');
      const tbody = document.getElementById('modalTableBody');
      const empty = document.getElementById('modalEmpty');
      overlay.classList.add('open');
      tbody.innerHTML = '';
      empty.style.display = 'none';
      fetch(API + '/fiscal/' + invoiceId + '/situacoes')
        .then(function (res) { return res.json(); })
        .then(function (list) {
          if (!Array.isArray(list) || !list.length) {
            empty.style.display = 'block';
            return;
          }
          list.forEach(function (s) {
            const tr = document.createElement('tr');
            const sitClass = (s.situacao || '').toUpperCase().replace(/\s/g, '_');
            tr.innerHTML =
              '<td>' + (s.data || '-') + '</td>' +
              '<td>' + (s.descricao || '-') + '</td>' +
              '<td><span class="situacao-badge ' + sitClass + '">' + (s.situacao || '-') + '</span></td>';
            tbody.appendChild(tr);
          });
        })
        .catch(function () {
          empty.textContent = 'Erro ao carregar situações.';
          empty.style.display = 'block';
        });
    }

    document.getElementById('modalClose').addEventListener('click', function () {
      document.getElementById('modalSituacoes').classList.remove('open');
    });
    document.getElementById('modalSituacoes').addEventListener('click', function (e) {
      if (e.target === this) this.classList.remove('open');
    });

    function openModalChamada(invoiceId) {
      const overlay = document.getElementById('modalChamada');
      const pre = document.getElementById('modalChamadaPre');
      const empty = document.getElementById('modalChamadaEmpty');
      overlay.classList.add('open');
      pre.style.display = 'block';
      pre.textContent = 'Carregando…';
      empty.style.display = 'none';
      fetch(API + '/fiscal/' + invoiceId + '/chamada')
        .then(function (res) { return res.json(); })
        .then(function (data) {
          if (data && data.message && Object.keys(data).length === 1) {
            pre.style.display = 'none';
            empty.textContent = data.message;
            empty.style.display = 'block';
            return;
          }
          pre.style.display = 'block';
          empty.style.display = 'none';
          pre.textContent = JSON.stringify(data, null, 2);
        })
        .catch(function () {
          pre.style.display = 'none';
          empty.textContent = 'Erro ao carregar a chamada.';
          empty.style.display = 'block';
        });
    }

    function openModalEditarFromInvoice(invoiceId) {
      var overlay = document.getElementById('modalAdicionarNF');
      overlay.classList.add('open');
      setModalNFMessage('Carregando…', 'info');
      fetch(API + '/fiscal/' + invoiceId + '/editar')
        .then(function (r) { return r.json().then(function (d) { return { ok: r.ok, data: d }; }); })
        .then(function (result) {
          if (!result.ok || (result.data && result.data.message && Object.keys(result.data).length === 1)) {
            setModalNFMessage(result.data && result.data.message ? result.data.message : 'Não foi possível carregar os dados da nota.', 'error');
            return;
          }
          var d = result.data;
          if (!d.payload || (!Array.isArray(d.payload.items) && !Array.isArray(d.payload.itens))) {
            setModalNFMessage('Payload inválido ou sem items.', 'error');
            return;
          }
          modalNFContext = {
            pedidoId: d.pedido_id || 0,
            empresaId: d.empresa_id || 0,
            naturezaId: d.natureza_operacao_id || 0
          };
          fillFormFromPayload(d.payload);
          // Corrige bug: ao abrir NF existente, o "Cliente" deve vir do relacionamento pedido -> contato.
          resolveClienteFromPedido(modalNFContext.pedidoId);
          setModalNFMessage('');
          if (typeof lucide !== 'undefined') lucide.createIcons();
        })
        .catch(function (e) {
          setModalNFMessage('Erro: ' + (e.message || 'ao carregar'), 'error');
        });
    }

    function handleNfeOpcao(action, invoiceId) {
      const base = window.location.origin;
      switch (action) {
        case 'cancelar':
          var justificativa = prompt('Justificativa do cancelamento (obrigatório, mín. 15 caracteres):');
          if (justificativa && justificativa.trim().length >= 15) {
            fetch(API + '/fiscal/' + invoiceId + '/cancelar', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ justificativa: justificativa.trim() })
            })
              .then(function (r) { return r.json().then(function (d) { return { ok: r.ok, data: d }; }); })
              .then(function (r) {
                if (r.ok) { showMessage('msg', 'Cancelamento enviado.', 'success'); loadInvoices(); }
                else { showMessage('msg', r.data.message || r.data.detail || 'Erro ao cancelar.', 'error'); }
              })
              .catch(function (e) { showMessage('msg', 'Erro: ' + (e.message || 'ao cancelar'), 'error'); });
          } else if (justificativa !== null) { showMessage('msg', 'Informe a justificativa (mínimo 15 caracteres).', 'error'); }
          break;
        case 'outras-opcoes':
          showMessage('msg', 'Outras opções de NF-e em desenvolvimento.', 'info');
          break;
        case 'carta-correcao':
          showMessage('msg', 'Carta de correção em desenvolvimento.', 'info');
          break;
        case 'nfe-complementar':
          showMessage('msg', 'NFe complementar em desenvolvimento.', 'info');
          break;
        case 'pdf':
          window.open(base + '/fiscal/' + invoiceId + '/pdf', '_blank');
          break;
        case 'boletos':
          showMessage('msg', 'Emitir boletos em desenvolvimento.', 'info');
          break;
        case 'lancar-contas':
          showMessage('msg', 'Lançar contas em desenvolvimento.', 'info');
          break;
        case 'lancar-estoque':
          showMessage('msg', 'Lançar estoque em desenvolvimento.', 'info');
          break;
        case 'gerar-devolucao':
          showMessage('msg', 'Gerar devolução em desenvolvimento.', 'info');
          break;
        case 'clonar':
          fetch(API + '/fiscal/' + invoiceId + '/clonar', { method: 'POST' })
            .then(function (r) { return r.json().then(function (d) { return { ok: r.ok, data: d }; }); })
            .then(function (r) {
              if (r.ok) { showMessage('msg', 'Nota clonada. Nova emissão em processamento.', 'success'); loadInvoices(); }
              else { showMessage('msg', r.data.message || 'Erro ao clonar.', 'error'); }
            })
            .catch(function (e) { showMessage('msg', 'Erro: ' + (e.message || 'ao clonar'), 'error'); });
          break;
        case 'clonar-entrada':
          showMessage('msg', 'Clonar para entrada em desenvolvimento.', 'info');
          break;
        case 'ver-json':
          openModalChamada(invoiceId);
          break;
        default:
          break;
      }
    }

    document.addEventListener('click', function () {
      document.querySelectorAll('.dropdown-nfe-opcoes.open').forEach(function (d) { d.classList.remove('open'); });
    });

    document.getElementById('modalChamadaClose').addEventListener('click', function () {
      document.getElementById('modalChamada').classList.remove('open');
    });
    document.getElementById('modalChamada').addEventListener('click', function (e) {
      if (e.target === this) this.classList.remove('open');
    });

    function openModalPreviewChamada() {
      const pedidoId = document.getElementById('pedidoId').value.trim();
      const empresaId = document.getElementById('empresaId').value.trim();
      const naturezaId = document.getElementById('naturezaId').value.trim();
      const overlay = document.getElementById('modalPreviewChamada');
      const pre = document.getElementById('modalPreviewChamadaPre');
      const empty = document.getElementById('modalPreviewChamadaEmpty');
      overlay.classList.add('open');
      pre.style.display = 'block';
      pre.textContent = 'Carregando…';
      empty.style.display = 'none';
      if (!pedidoId || parseInt(pedidoId, 10) < 1) {
        pre.style.display = 'none';
        empty.textContent = 'Informe o ID do pedido para verificar a chamada.';
        empty.style.display = 'block';
        return;
      }
      const body = { pedidoId: parseInt(pedidoId, 10) };
      if (empresaId) body.empresa_id = parseInt(empresaId, 10);
      if (naturezaId) body.natureza_operacao_id = parseInt(naturezaId, 10);
      fetch(API + '/fiscal/preview-chamada', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      })
        .then(function (res) { return res.json().then(function (data) { return { res: res, data: data }; }); })
        .then(function (result) {
          if (!result.res.ok) {
            pre.style.display = 'none';
            empty.textContent = result.data.message || result.data.detail || 'Erro ao montar a chamada.';
            empty.style.display = 'block';
            return;
          }
          pre.style.display = 'block';
          empty.style.display = 'none';
          pre.textContent = JSON.stringify(result.data, null, 2);
        })
        .catch(function (e) {
          pre.style.display = 'none';
          empty.textContent = 'Erro de rede: ' + (e.message || 'Erro ao carregar.');
          empty.style.display = 'block';
        });
    }

    document.getElementById('modalPreviewChamadaClose').addEventListener('click', function () {
      document.getElementById('modalPreviewChamada').classList.remove('open');
    });
    document.getElementById('modalPreviewChamada').addEventListener('click', function (e) {
      if (e.target === this) this.classList.remove('open');
    });

    function openModalPreviewChamadaFromForm() {
      var overlay = document.getElementById('modalPreviewChamada');
      var pre = document.getElementById('modalPreviewChamadaPre');
      var empty = document.getElementById('modalPreviewChamadaEmpty');
      overlay.classList.add('open');
      pre.style.display = 'block';
      empty.style.display = 'none';
      try {
        var payload = getPayloadFromForm();
        var envelope = {
          pedido_id: modalNFContext.pedidoId,
          empresa_id: modalNFContext.empresaId,
          natureza_operacao_id: modalNFContext.naturezaId,
          payload: payload
        };
        pre.textContent = JSON.stringify(envelope, null, 2);
      } catch (e) {
        pre.style.display = 'none';
        empty.textContent = 'Erro ao montar o JSON: ' + (e.message || '');
        empty.style.display = 'block';
      }
    }

    // --- Modal Adicionar NF (formulário completo; usa Empresa, Natureza e Pedido da página) ---
    var modalNFContext = { pedidoId: 0, empresaId: 0, naturezaId: 0 };

    function setModalNFMessage(text, type) {
      var el = document.getElementById('modalAdicionarNFMessage');
      el.textContent = text;
      el.className = 'message ' + (type || 'info');
      el.style.display = text ? 'block' : 'none';
    }

    function resetModalNF() {
      setModalNFMessage('');
      var sheet = document.getElementById('sheetItemNF');
      if (sheet) sheet.classList.remove('open');
      sheetItemNFRow = null;
      var modal = document.getElementById('modalAdicionarNF');
      modal.querySelectorAll('input').forEach(function (inp) {
        if (inp.type === 'checkbox') inp.checked = false;
        else inp.value = '';
      });
      if (fpDataEmissao) fpDataEmissao.clear();
      if (fpDataEntradaSaida) fpDataEntradaSaida.clear();
      modal.querySelectorAll('select').forEach(function (sel) {
        var def = { nf_consumidor_final: '1', nf_presenca_comprador: '2', nf_local_destino: '1', nf_indicador_ie_dest: '2', nf_transporte: 'nao', nf_frete_por_conta: '0', nf_tipo_pessoa_dest: '' }[sel.id];
        sel.value = def != null ? def : (sel.options[0] ? sel.options[0].value : '');
      });
      updateDocDestUI();
      var tbody = document.getElementById('nfItemsBody');
      if (tbody) tbody.innerHTML = '';
      modalNFContext = { pedidoId: 0, empresaId: 0, naturezaId: 0 };
      selectedContatoId = null;
      var buscaEl = document.getElementById('nf_cliente_busca');
      if (buscaEl) buscaEl.value = '';
      var listEl = document.getElementById('nf_cliente_contatos_list');
      if (listEl) { listEl.innerHTML = ''; listEl.style.display = 'none'; }
      updateClienteBtnIcon();
    }

    var selectedContatoId = null;
    function updateClienteBtnIcon() {
      var btn = document.getElementById('nf_cliente_btn_add_edit');
      if (!btn) return;
      btn.innerHTML = selectedContatoId ? '<i data-lucide="pen"></i>' : '<i data-lucide="plus"></i>';
      btn.setAttribute('aria-label', selectedContatoId ? 'Editar cliente' : 'Adicionar cliente');
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function setClienteUI(nome, contatoId) {
      var inputEl = document.getElementById('nf_cliente_busca');
      var hiddenEl = document.getElementById('nf_nome_destinatario');
      var n = nome != null ? String(nome).trim() : '';
      if (inputEl) inputEl.value = n;
      if (hiddenEl) hiddenEl.value = n;
      selectedContatoId = contatoId != null && !isNaN(Number(contatoId)) ? Number(contatoId) : null;
      var listEl = document.getElementById('nf_cliente_contatos_list');
      if (listEl) { listEl.innerHTML = ''; listEl.style.display = 'none'; }
      updateClienteBtnIcon();
    }

    function resolveClienteFromPedido(pedidoId) {
      pedidoId = pedidoId ? parseInt(String(pedidoId), 10) : 0;
      if (!pedidoId || pedidoId < 1) {
        setClienteUI('', null);
        return Promise.resolve(null);
      }
      return fetch(API + '/fiscal/pedidos/' + pedidoId + '/cliente')
        .then(function (r) { return r.json().then(function (d) { return { ok: r.ok, data: d }; }); })
        .then(function (result) {
          if (!result.ok || !result.data || typeof result.data !== 'object') return null;
          var contatoId = result.data.contato_id != null ? Number(result.data.contato_id) : null;
          var nome = result.data.nome != null ? String(result.data.nome) : '';
          if (nome) setClienteUI(nome, contatoId);
          else setClienteUI('', contatoId);
          return result.data;
        })
        .catch(function () { return null; });
    }

    function fillDestinatarioFromCliente(c) {
      if (!c) return;
      var set = function (id, val) { var el = document.getElementById(id); if (el && val !== undefined && val !== null) el.value = String(val); };
      set('nf_nome_destinatario', c.nome || c.razao_social || c.nome_fantasia);
      var cpfCnpj = (c.cpf_cnpj || '').toString().replace(/\D/g, '');
      var tipoSel = document.getElementById('nf_tipo_pessoa_dest');
      var docInp = document.getElementById('nf_cpf_cnpj_dest');
      if (tipoSel && docInp) {
        tipoSel.value = cpfCnpj.length === 11 ? 'pf' : cpfCnpj.length === 14 ? 'pj' : 'pj';
        docInp.value = cpfCnpj.length === 11 ? maskCPF(cpfCnpj) : maskCNPJ(cpfCnpj);
        updateDocDestUI();
      }
      set('nf_inscricao_estadual_destinatario', c.ie);
      set('nf_logradouro_destinatario', c.logradouro);
      set('nf_numero_destinatario', c.numero);
      set('nf_bairro_destinatario', c.bairro);
      set('nf_municipio_destinatario', c.municipio);
      set('nf_uf_destinatario', c.uf);
      set('nf_cep_destinatario', c.cep);
      set('nf_pais_destinatario', c.pais || 'Brasil');
      set('nf_telefone_destinatario', c.celular || c.telefoneFixo || c.telefone_destinatario);
    }

    function onlyNumbers(s) {
      if (!s) return '';
      return String(s).replace(/\D/g, '');
    }
    function maskCPF(v) {
      var d = onlyNumbers(v).slice(0, 11);
      if (d.length <= 3) return d;
      if (d.length <= 6) return d.slice(0, 3) + '.' + d.slice(3);
      if (d.length <= 9) return d.slice(0, 3) + '.' + d.slice(3, 6) + '.' + d.slice(6);
      return d.slice(0, 3) + '.' + d.slice(3, 6) + '.' + d.slice(6, 9) + '-' + d.slice(9);
    }
    function maskCNPJ(v) {
      var d = onlyNumbers(v).slice(0, 14);
      if (d.length <= 2) return d;
      if (d.length <= 5) return d.slice(0, 2) + '.' + d.slice(2);
      if (d.length <= 8) return d.slice(0, 2) + '.' + d.slice(2, 5) + '.' + d.slice(5);
      if (d.length <= 12) return d.slice(0, 2) + '.' + d.slice(2, 5) + '.' + d.slice(5, 8) + '/' + d.slice(8);
      return d.slice(0, 2) + '.' + d.slice(2, 5) + '.' + d.slice(5, 8) + '/' + d.slice(8, 12) + '-' + d.slice(12);
    }
    function isValidCPF(digits) {
      if (!digits || digits.length !== 11) return false;
      if (/^(\d)\1{10}$/.test(digits)) return false;
      var sum = 0; for (var i = 0; i < 9; i++) sum += parseInt(digits[i], 10) * (10 - i);
      var d1 = (sum * 10) % 11; if (d1 === 10) d1 = 0; if (d1 !== parseInt(digits[9], 10)) return false;
      sum = 0; for (i = 0; i < 10; i++) sum += parseInt(digits[i], 10) * (11 - i);
      var d2 = (sum * 10) % 11; if (d2 === 10) d2 = 0; if (d2 !== parseInt(digits[10], 10)) return false;
      return true;
    }
    function isValidCNPJ(digits) {
      if (!digits || digits.length !== 14) return false;
      if (/^(\d)\1{13}$/.test(digits)) return false;
      var w1 = [5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];
      var sum = 0; for (var i = 0; i < 12; i++) sum += parseInt(digits[i], 10) * w1[i];
      var d1 = sum % 11; d1 = d1 < 2 ? 0 : 11 - d1; if (d1 !== parseInt(digits[12], 10)) return false;
      var w2 = [6, 5, 4, 3, 2, 9, 8, 7, 6, 5, 4, 3, 2];
      sum = 0; for (i = 0; i < 13; i++) sum += parseInt(digits[i], 10) * w2[i];
      var d2 = sum % 11; d2 = d2 < 2 ? 0 : 11 - d2; if (d2 !== parseInt(digits[13], 10)) return false;
      return true;
    }
    function validateDocDest() {
      var tipo = document.getElementById('nf_tipo_pessoa_dest').value;
      var inp = document.getElementById('nf_cpf_cnpj_dest');
      var digits = onlyNumbers(inp ? inp.value : '');
      if (!tipo) return { valid: false, error: 'Selecione o tipo de pessoa' };
      if (!digits) return { valid: false, error: 'Informe o documento' };
      if (tipo === 'pf') {
        if (digits.length !== 11) return { valid: false, error: 'CPF deve ter 11 dígitos' };
        if (!isValidCPF(digits)) return { valid: false, error: 'CPF inválido' };
      } else {
        if (digits.length !== 14) return { valid: false, error: 'CNPJ deve ter 14 dígitos' };
        if (!isValidCNPJ(digits)) return { valid: false, error: 'CNPJ inválido' };
      }
      return { valid: true };
    }
    function setDocDestError(msg) {
      var wrap = document.getElementById('nf_doc_dest_wrap');
      var errEl = document.getElementById('nf_doc_dest_error');
      if (wrap) wrap.classList.add('has-error');
      if (errEl) { errEl.textContent = msg || ''; errEl.style.display = msg ? 'block' : 'none'; }
    }
    function clearDocDestError() {
      var wrap = document.getElementById('nf_doc_dest_wrap');
      var errEl = document.getElementById('nf_doc_dest_error');
      if (wrap) wrap.classList.remove('has-error');
      if (errEl) { errEl.textContent = ''; errEl.style.display = 'none'; }
    }
    function updateDocDestUI() {
      var tipo = document.getElementById('nf_tipo_pessoa_dest').value;
      var labelEl = document.getElementById('nf_doc_dest_label');
      var inp = document.getElementById('nf_cpf_cnpj_dest');
      if (labelEl) labelEl.textContent = tipo === 'pf' ? 'CPF' : tipo === 'pj' ? 'CNPJ' : 'CPF ou CNPJ';
      if (inp) {
        inp.placeholder = tipo === 'pf' ? '000.000.000-00' : tipo === 'pj' ? '00.000.000/0000-00' : 'Selecione o tipo de pessoa';
        inp.maxLength = tipo === 'pf' ? 14 : tipo === 'pj' ? 18 : 18;
        var digits = onlyNumbers(inp.value);
        inp.value = tipo === 'pf' ? maskCPF(digits) : tipo === 'pj' ? maskCNPJ(digits) : digits;
      }
      clearDocDestError();
    }
    function buscaCep(cepInputId, logradouroId, bairroId, municipioId, ufId) {
      var cepEl = document.getElementById(cepInputId);
      if (!cepEl) return;
      var cep = onlyNumbers(cepEl.value);
      if (cep.length !== 8) return;
      fetch('https://viacep.com.br/ws/' + cep + '/json/')
        .then(function (r) { return r.json(); })
        .then(function (data) {
          if (data.erro) {
            setModalNFMessage('CEP não encontrado.', 'error');
            return;
          }
          var logEl = document.getElementById(logradouroId);
          var bairroEl = document.getElementById(bairroId);
          var municipioEl = document.getElementById(municipioId);
          var ufEl = document.getElementById(ufId);
          if (logEl) logEl.value = data.logradouro || '';
          if (bairroEl) bairroEl.value = data.bairro || '';
          if (municipioEl) municipioEl.value = data.localidade || '';
          if (ufEl) ufEl.value = data.uf || '';
          setModalNFMessage('');
        })
        .catch(function () {
          setModalNFMessage('Erro ao consultar CEP.', 'error');
        });
    }

    function fillFormFromPayload(p) {
      if (!p) return;
      var set = function (id, val) {
        var el = document.getElementById(id);
        if (el && val !== undefined && val !== null) el.value = String(val);
      };
      var setNum = function (id, val) {
        var el = document.getElementById(id);
        if (el) el.value = val !== undefined && val !== null && !isNaN(Number(val)) ? String(Number(val)) : '';
      };
      var setSel = function (id, val) {
        var el = document.getElementById(id);
        if (el) el.value = val !== undefined && val !== null ? String(val) : '';
      };
      var toDatetimeLocal = function (v) {
        if (!v || typeof v !== 'string') return '';
        var s = v.replace(/\.\d{3}Z?$/, '').slice(0, 19);
        return s.length >= 16 ? s : '';
      };
      set('nf_natureza_operacao', p.natureza_operacao);
      var dtEmissao = toDatetimeLocal(p.data_emissao);
      var dtEntradaSaida = toDatetimeLocal(p.data_entrada_saida);
      if (fpDataEmissao) { if (dtEmissao) fpDataEmissao.setDate(dtEmissao); else fpDataEmissao.clear(); }
      else set('nf_data_emissao', dtEmissao);
      if (fpDataEntradaSaida) { if (dtEntradaSaida) fpDataEntradaSaida.setDate(dtEntradaSaida); else fpDataEntradaSaida.clear(); }
      else set('nf_data_entrada_saida', dtEntradaSaida);
      set('nf_finalidade_emissao', p.finalidade_emissao);
      setSel('nf_consumidor_final', p.consumidor_final);
      setSel('nf_presenca_comprador', p.presenca_comprador);
      setSel('nf_local_destino', p.local_destino);
      setSel('nf_indicador_ie_dest', p.indicador_inscricao_estadual_destinatario);
      set('nf_cnpj_emitente', p.cnpj_emitente);
      set('nf_nome_emitente', p.nome_emitente);
      set('nf_nome_fantasia_emitente', p.nome_fantasia_emitente);
      set('nf_inscricao_estadual_emitente', p.inscricao_estadual_emitente);
      set('nf_logradouro_emitente', p.logradouro_emitente);
      set('nf_numero_emitente', p.numero_emitente);
      set('nf_bairro_emitente', p.bairro_emitente);
      set('nf_municipio_emitente', p.municipio_emitente);
      set('nf_uf_emitente', p.uf_emitente);
      set('nf_cep_emitente', p.cep_emitente);
      set('nf_telefone_emitente', p.telefone_emitente);
      set('nf_nome_destinatario', p.nome_destinatario);
      // Campo "Cliente" é apenas exibição (derivado do pedido -> contato).
      // Aqui usamos o nome do payload como fallback (ex.: em visualização), mas ele pode ser re-resolvido via pedido_id.
      setClienteUI(p.nome_destinatario || '', selectedContatoId);
      var cpfCnpj = (p.cpf_destinatario || p.cnpj_destinatario || '').toString().replace(/\D/g, '');
      var tipoSel = document.getElementById('nf_tipo_pessoa_dest');
      var docInp = document.getElementById('nf_cpf_cnpj_dest');
      if (tipoSel && docInp) {
        tipoSel.value = cpfCnpj.length === 11 ? 'pf' : cpfCnpj.length === 14 ? 'pj' : '';
        docInp.value = cpfCnpj.length === 11 ? maskCPF(cpfCnpj) : cpfCnpj.length === 14 ? maskCNPJ(cpfCnpj) : cpfCnpj;
        updateDocDestUI();
      }
      set('nf_inscricao_estadual_destinatario', p.inscricao_estadual_destinatario);
      set('nf_telefone_destinatario', p.telefone_destinatario);
      set('nf_logradouro_destinatario', p.logradouro_destinatario);
      set('nf_numero_destinatario', p.numero_destinatario);
      set('nf_bairro_destinatario', p.bairro_destinatario);
      set('nf_municipio_destinatario', p.municipio_destinatario);
      set('nf_uf_destinatario', p.uf_destinatario);
      set('nf_pais_destinatario', p.pais_destinatario);
      set('nf_cep_destinatario', p.cep_destinatario);
      setNum('nf_valor_produtos', p.valor_produtos);
      setNum('nf_valor_frete', p.valor_frete);
      setNum('nf_valor_desconto', p.valor_desconto);
      setNum('nf_valor_total', p.valor_total);
      setNum('nf_total_produtos', p.valor_produtos);
      setNum('nf_valor_frete_calc', p.valor_frete);
      setNum('nf_valor_seguro_calc', p.valor_seguro);
      setNum('nf_outras_despesas', 0);
      setNum('nf_desconto_calc', p.valor_desconto);
      setNum('nf_total_nota', p.valor_total);
      setNum('nf_base_icms', p.base_icms);
      setNum('nf_valor_icms', p.valor_icms);
      setNum('nf_base_icms_st', p.base_icms_st);
      setNum('nf_valor_icms_st', p.valor_icms_st);
      setNum('nf_valor_ipi', p.valor_ipi);
      setNum('nf_total_is', p.total_is);
      setNum('nf_total_ibs', p.total_ibs);
      setNum('nf_total_cbs', p.total_cbs);
      setNum('nf_total_tributos', p.valor_aproximado_tributos);
      var infoContrib = (p.informacoes_adicionais_contribuinte != null ? String(p.informacoes_adicionais_contribuinte) : '').trim();
      var idxTrib = infoContrib.indexOf('Total aproximado de tributos');
      var elNat = document.getElementById('nf_info_complementares_natureza');
      if (elNat) elNat.value = idxTrib > 0 ? infoContrib.slice(0, idxTrib).trim() : (idxTrib === 0 ? '' : infoContrib);
      var elInfo = document.getElementById('nf_info_complementares');
      if (elInfo) elInfo.value = infoContrib;
      var tbody = document.getElementById('nfItemsBody');
      tbody.innerHTML = '';
      (p.items || p.itens || []).forEach(function (item, idx) {
        addItemRow(item, idx + 1);
      });
      updateModalCalcTotais();
    }

    function formatValorBruto(item) {
      var q = Number(item.quantidade_comercial ?? 0);
      var v = Number(item.valor_unitario_comercial ?? 0);
      var total = Math.round(q * v * 100) / 100;
      return total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function updateValorBruto(tr) {
      var qInp = tr.querySelector('input[data-field="quantidade_comercial"]');
      var vInp = tr.querySelector('input[data-field="valor_unitario_comercial"]');
      var span = tr.querySelector('.valor-bruto-display');
      if (!span || !qInp || !vInp) return;
      var q = parseFloat(qInp.value) || 0;
      var v = parseFloat(vInp.value) || 0;
      var total = Math.round(q * v * 100) / 100;
      span.textContent = total.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      updateModalCalcTotais();
    }

    function updateModalCalcTotais() {
      var toggle = document.getElementById('nfCalcAutoToggle');
      if (!toggle || !toggle.classList.contains('on')) return;
      var tbody = document.getElementById('nfItemsBody');
      if (!tbody) return;
      var CST_COM_BC = ['00', '10', '20', '51', '70', '90'];
      var totProdutos = 0, baseIcms = 0, valorIcms = 0, baseIcmsSt = 0, valorIcmsSt = 0, valorIpi = 0;
      var valorPis = 0, valorCofins = 0;
      var rows = tbody.querySelectorAll('tr');
      var vBrutos = [];
      rows.forEach(function (tr) {
        var span = tr.querySelector('.valor-bruto-display');
        var qInp = tr.querySelector('input[data-field="quantidade_comercial"]');
        var vInp = tr.querySelector('input[data-field="valor_unitario_comercial"]');
        var vBruto = 0;
        if (span) {
          var txt = span.textContent.replace(/\./g, '').replace(',', '.');
          vBruto = parseFloat(txt) || 0;
        } else if (qInp && vInp) {
          vBruto = (parseFloat(qInp.value) || 0) * (parseFloat(vInp.value) || 0);
          vBruto = Math.round(vBruto * 100) / 100;
        }
        totProdutos += vBruto;
        vBrutos.push(vBruto);
      });
      var frete = parseFloat(document.getElementById('nf_valor_frete').value) || 0;
      var freteRounded = Math.round(frete * 100) / 100;
      var fretePorItem = [];
      if (freteRounded > 0 && rows.length > 0) {
        if (rows.length === 1) {
          fretePorItem[0] = freteRounded;
        } else {
          var totSafe = totProdutos > 0 ? totProdutos : 1;
          var somaF = 0;
          for (var i = 0; i < rows.length; i++) {
            var fItem = Math.round((vBrutos[i] / totSafe) * freteRounded * 100) / 100;
            fretePorItem.push(fItem);
            somaF += fItem;
          }
          var diff = Math.round((freteRounded - somaF) * 100) / 100;
          if (diff !== 0) fretePorItem[rows.length - 1] = Math.round((fretePorItem[rows.length - 1] + diff) * 100) / 100;
        }
      } else {
        for (var j = 0; j < rows.length; j++) fretePorItem.push(0);
      }
      rows.forEach(function (tr, idx) {
        var vBruto = vBrutos[idx] || 0;
        var valorFreteItem = fretePorItem[idx] != null ? fretePorItem[idx] : (parseFloat(tr.dataset.valorFrete) || 0);
        var baseItem = Math.round((vBruto + valorFreteItem) * 100) / 100;
        var cst = (tr.dataset.icmsSt || '400').trim();
        if (CST_COM_BC.indexOf(cst) >= 0) {
          baseIcms += baseItem;
          var aliqIcms = parseFloat(tr.dataset.icmsAliquota) || 0;
          valorIcms += Math.round(baseItem * aliqIcms) / 100;
        } else {
          valorIcms += parseFloat(tr.dataset.icmsValor) || 0;
        }
        baseIcmsSt += parseFloat(tr.dataset.icmsBaseSt) || 0;
        valorIcmsSt += parseFloat(tr.dataset.icmsValorSt) || 0;
        valorIpi += parseFloat(tr.dataset.ipiValor) || 0;
        var pisV = parseFloat(tr.dataset.pisValor);
        if (!isNaN(pisV)) valorPis += pisV;
        else {
          var basePis = parseFloat(tr.dataset.pisBaseCalculo) || 100;
          var aliqPis = parseFloat(tr.dataset.pisAliquotaPorcentual) || 0;
          valorPis += Math.round(baseItem * (basePis / 100) * (aliqPis / 100) * 100) / 100;
        }
        var cofV = parseFloat(tr.dataset.cofinsValor);
        if (!isNaN(cofV)) valorCofins += cofV;
        else {
          var baseCof = parseFloat(tr.dataset.cofinsBaseCalculo) || 100;
          var aliqCof = parseFloat(tr.dataset.cofinsAliquotaPorcentual) || 0;
          valorCofins += Math.round(baseItem * (baseCof / 100) * (aliqCof / 100) * 100) / 100;
        }
      });
      var desconto = parseFloat(document.getElementById('nf_valor_desconto').value) || 0;
      var totalNota = Math.round((totProdutos + frete - desconto) * 100) / 100;
      // Total A. Tributos (Lei 12.741): valor aproximado = % sobre o total da nota (produtos + frete - desconto)
      var PERC_APROX_TRIB = 15.25;
      var totalTributos = totalNota > 0 ? Math.round(totalNota * (PERC_APROX_TRIB / 100) * 100) / 100 : 0;
      function setNum(id, v) {
        var el = document.getElementById(id);
        if (el) el.value = v != null && !isNaN(v) ? String(Math.round(v * 100) / 100) : '0';
      }
      setNum('nf_total_produtos', totProdutos);
      setNum('nf_valor_produtos', totProdutos);
      setNum('nf_valor_frete_calc', frete);
      setNum('nf_valor_seguro_calc', 0);
      setNum('nf_outras_despesas', 0);
      setNum('nf_desconto_calc', desconto);
      setNum('nf_total_nota', totalNota);
      setNum('nf_valor_total', totalNota);
      setNum('nf_base_icms', baseIcms);
      setNum('nf_valor_icms', valorIcms);
      setNum('nf_base_icms_st', baseIcmsSt);
      setNum('nf_valor_icms_st', valorIcmsSt);
      setNum('nf_valor_ipi', valorIpi);
      setNum('nf_total_servicos', 0);
      setNum('nf_valor_issqn', 0);
      setNum('nf_valor_funrural', 0);
      setNum('nf_total_faturado', totalNota);
      setNum('nf_total_tributos', totalTributos);
      // Informações adicionais:
      // - parte inicial: texto livre (infoAdicionais / edição do usuário)
      // - parte final: bloco IBPT "Total aproximado de tributos..."
      var infoEl = document.getElementById('nf_info_complementares');
      if (infoEl) {
        var current = String(infoEl.value || '');
        var marker = 'Total aproximado de tributos';
        var idx = current.indexOf(marker);
        var baseNatureza = idx >= 0 ? current.slice(0, idx).trimEnd() : current.trimEnd();
        var newValue = baseNatureza;
        if (totalTributos > 0) {
          var PERC_FED = 13.45, PERC_EST = 1.80;
          var tribTotal = Math.round(totalTributos * 100) / 100;
          var fatorFed = PERC_FED / PERC_APROX_TRIB;
          var tribFederais = Math.round(tribTotal * fatorFed * 100) / 100;
          var tribEstaduais = Math.round((tribTotal - tribFederais) * 100) / 100;
          var fmt = function (v) { return v.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); };
          var ibptText = 'Total aproximado de tributos: R$ ' + fmt(tribTotal) + ' (' + PERC_APROX_TRIB.toString().replace('.', ',') + '%) Federais R$ ' + fmt(tribFederais) + ' (' + PERC_FED.toString().replace('.', ',') + '%) Estaduais R$ ' + fmt(tribEstaduais) + ' (' + PERC_EST.toString().replace('.', ',') + '%). Fonte IBPT.';
          newValue = baseNatureza ? baseNatureza + '\n\n' + ibptText : ibptText;
        }
        infoEl.value = newValue;
      }
    }

    function addItemRow(item, num) {
      item = item || {};
      var tbody = document.getElementById('nfItemsBody');
      var tr = document.createElement('tr');
      var descVal = (item.descricao || '').replace(/"/g, '&quot;');
      tr.innerHTML =
        '<td class="col-num col-item-num">' + (num || tbody.querySelectorAll("tr").length + 1) + '</td>' +
        '<td class="col-desc"><div class="nf-produto-ac-wrap"><input type="text" data-field="descricao" value="' + descVal + '" autocomplete="off" placeholder="Buscar por nome"><ul class="nf-produto-ac-list"></ul></div></td>' +
        '<td class="col-num"><input type="text" data-field="codigo_produto" value="' + (item.codigo_produto || '').replace(/"/g, '&quot;') + '"></td>' +
        '<td class="col-ncm"><input type="text" data-field="codigo_ncm" value="' + (item.codigo_ncm || '').replace(/"/g, '&quot;') + '" maxlength="8"></td>' +
        '<td><input type="text" data-field="unidade_comercial" value="' + (item.unidade_comercial || 'UN').replace(/"/g, '&quot;') + '"></td>' +
        '<td class="col-num"><input type="number" data-field="quantidade_comercial" step="0.01" min="0" value="' + (item.quantidade_comercial ?? '') + '"></td>' +
        '<td class="col-num"><input type="number" data-field="valor_unitario_comercial" step="0.01" min="0" value="' + (item.valor_unitario_comercial ?? '') + '"></td>' +
        '<td class="col-num"><span class="valor-bruto-display">' + formatValorBruto(item) + '</span></td>' +
        '<td class="col-del"><span class="col-del-btns"><button type="button" class="btn-lupa btn-edit-item" aria-label="Editar"><i data-lucide="pen"></i></button><button type="button" class="btn-lupa btn-remove-item" aria-label="Remover"><i data-lucide="trash-2"></i></button></span></td>';
      if (item.icms_situacao_tributaria) tr.dataset.icmsSt = item.icms_situacao_tributaria;
      if (item.icms_origem != null && item.icms_origem !== '') tr.dataset.icmsOrigem = String(item.icms_origem);
      if (item.pis_situacao_tributaria) tr.dataset.pisSt = item.pis_situacao_tributaria;
      if (item.cofins_situacao_tributaria) tr.dataset.cofinsSt = item.cofins_situacao_tributaria;
      if (item.cfop) tr.dataset.cfop = item.cfop;
      if (item.tipo != null && item.tipo !== '') tr.dataset.tipo = String(item.tipo);
      if (item.pis_aliquota_porcentual != null && item.pis_aliquota_porcentual !== '') tr.dataset.pisAliquotaPorcentual = String(item.pis_aliquota_porcentual);
      if (item.cofins_aliquota_porcentual != null && item.cofins_aliquota_porcentual !== '') tr.dataset.cofinsAliquotaPorcentual = String(item.cofins_aliquota_porcentual);
      if (item.pis_base_calculo != null && item.pis_base_calculo !== '') tr.dataset.pisBaseCalculo = String(item.pis_base_calculo);
      if (item.cofins_base_calculo != null && item.cofins_base_calculo !== '') tr.dataset.cofinsBaseCalculo = String(item.cofins_base_calculo);
      if (item.pis_valor != null && item.pis_valor !== '') tr.dataset.pisValor = String(item.pis_valor);
      if (item.cofins_valor != null && item.cofins_valor !== '') tr.dataset.cofinsValor = String(item.cofins_valor);
      if (item.icms_modalidade_base_calculo != null && item.icms_modalidade_base_calculo !== '') tr.dataset.icmsModalidadeBaseCalculo = String(item.icms_modalidade_base_calculo);
      if (item.icms_aliquota != null && item.icms_aliquota !== '') tr.dataset.icmsAliquota = String(item.icms_aliquota);
      if (item.icms_valor != null && item.icms_valor !== '') tr.dataset.icmsValor = String(item.icms_valor);
      if (item.ipi_situacao_tributaria != null && item.ipi_situacao_tributaria !== '') tr.dataset.ipiSt = String(item.ipi_situacao_tributaria);
      if (item.ipi_codigo_enquadramento_legal != null && item.ipi_codigo_enquadramento_legal !== '') tr.dataset.ipiCodEnquadramento = String(item.ipi_codigo_enquadramento_legal);
      if (item.ipi_valor != null && item.ipi_valor !== '') tr.dataset.ipiValor = String(item.ipi_valor);
      if (item.ipi_aliquota != null && item.ipi_aliquota !== '') tr.dataset.ipiAliquota = String(item.ipi_aliquota);
      if (item.valor_frete != null && item.valor_frete !== '') tr.dataset.valorFrete = String(item.valor_frete);
      else tr.dataset.valorFrete = '0';
      tbody.appendChild(tr);
      var wrap = tr.querySelector('.nf-produto-ac-wrap');
      var descInput = tr.querySelector('input[data-field="descricao"]');
      var listEl = tr.querySelector('.nf-produto-ac-list');
      var acTimeout;
      function hideList() { listEl.style.display = 'none'; listEl.innerHTML = ''; }
      function showList(items) {
        listEl.innerHTML = '';
        items.forEach(function (p) {
          var li = document.createElement('li');
          li.textContent = (p.nome || '') + (p.sku ? ' (SKU: ' + p.sku + ')' : '');
          li.dataset.id = String(p.id);
          li.dataset.nome = p.nome || '';
          li.dataset.sku = p.sku || '';
          li.dataset.preco = p.preco != null ? String(p.preco) : '';
          li.addEventListener('click', function () {
            descInput.value = li.dataset.nome || '';
            var codigoInp = tr.querySelector('input[data-field="codigo_produto"]');
            if (codigoInp) codigoInp.value = li.dataset.sku || li.dataset.id || '';
            var precoInp = tr.querySelector('input[data-field="valor_unitario_comercial"]');
            if (precoInp && li.dataset.preco) precoInp.value = li.dataset.preco;
            updateValorBruto(tr);
            // Busca tributação do produto selecionado para preencher NCM/CST e outros campos fiscais
            if (li.dataset.id) {
              fetch(API + '/fiscal/produtos/' + encodeURIComponent(li.dataset.id) + '/tributacao')
                .then(function (r) { return r.json(); })
                .then(function (trib) {
                  if (!trib || trib.message) return;
                  var ncmInp = tr.querySelector('input[data-field="codigo_ncm"]');
                  if (ncmInp && trib.codigo_ncm) ncmInp.value = trib.codigo_ncm;
                  tr.dataset.icmsOrigem = trib.icms_origem || '';
                  tr.dataset.icmsSt = trib.icms_situacao_tributaria || '';
                  tr.dataset.pisSt = trib.pis_situacao_tributaria || '';
                  tr.dataset.cofinsSt = trib.cofins_situacao_tributaria || '';
                  if (trib.tipo != null && trib.tipo !== '') tr.dataset.tipo = String(trib.tipo);
                  if (trib.pis_aliquota_porcentual != null && trib.pis_aliquota_porcentual !== '') tr.dataset.pisAliquotaPorcentual = String(trib.pis_aliquota_porcentual);
                  if (trib.cofins_aliquota_porcentual != null && trib.cofins_aliquota_porcentual !== '') tr.dataset.cofinsAliquotaPorcentual = String(trib.cofins_aliquota_porcentual);
                })
                .catch(function () { /* silencioso */ });
            }
            hideList();
          });
          listEl.appendChild(li);
        });
        listEl.style.display = items.length ? 'block' : 'none';
      }
      descInput.addEventListener('input', function () {
        clearTimeout(acTimeout);
        var q = descInput.value.trim();
        if (q.length < 2) { hideList(); return; }
        acTimeout = setTimeout(function () {
          fetch(API + '/fiscal/produtos?q=' + encodeURIComponent(q))
            .then(function (r) { return r.json(); })
            .then(function (arr) { showList(Array.isArray(arr) ? arr : []); })
            .catch(function () { hideList(); });
        }, 300);
      });
      descInput.addEventListener('focus', function () {
        var q = descInput.value.trim();
        if (q.length >= 2) fetch(API + '/fiscal/produtos?q=' + encodeURIComponent(q))
          .then(function (r) { return r.json(); })
          .then(function (arr) { showList(Array.isArray(arr) ? arr : []); });
      });
      descInput.addEventListener('blur', function () {
        setTimeout(hideList, 200);
      });
      var qtdInp = tr.querySelector('input[data-field="quantidade_comercial"]');
      var valUnitInp = tr.querySelector('input[data-field="valor_unitario_comercial"]');
      if (qtdInp) qtdInp.addEventListener('input', function () { updateValorBruto(tr); });
      if (valUnitInp) valUnitInp.addEventListener('input', function () { updateValorBruto(tr); });
      tr.querySelector('.btn-remove-item').addEventListener('click', function () {
        tr.remove();
        renumberItems();
        updateModalCalcTotais();
      });
      if (tr.querySelector('.btn-edit-item')) {
        tr.querySelector('.btn-edit-item').addEventListener('click', function () {
          openSheetItemNF(tr);
        });
      }
      if (typeof lucide !== 'undefined') lucide.createIcons();
      updateModalCalcTotais();
    }

    function renumberItems() {
      document.getElementById('nfItemsBody').querySelectorAll('tr').forEach(function (tr, i) {
        var first = tr.querySelector('td.col-num');
        if (first) first.textContent = i + 1;
      });
    }

    var sheetItemNFRow = null;

    function openSheetItemNF(tr) {
      sheetItemNFRow = tr;
      var item = {};
      tr.querySelectorAll('input[data-field]').forEach(function (inp) {
        var f = inp.getAttribute('data-field');
        var v = inp.value;
        if (f === 'quantidade_comercial') item[f] = parseFloat(v) || 0;
        else if (f === 'valor_unitario_comercial') item[f] = parseFloat(v) || 0;
        else if (v) item[f] = v;
      });
      var spanValor = tr.querySelector('.valor-bruto-display');
      if (spanValor) item.valor_bruto = parseFloat(spanValor.textContent.replace(/\./g, '').replace(',', '.')) || 0;
      item.codigo_ncm = (item.codigo_ncm || '').replace(/\D/g, '').padStart(8, '0').slice(0, 8) || '00000000';
      item.cfop = tr.dataset.cfop || item.cfop || '5102';
      item.icms_situacao_tributaria = tr.dataset.icmsSt || item.icms_situacao_tributaria || '400';
      item.icms_origem = tr.dataset.icmsOrigem || item.icms_origem || '0';
      item.pis_situacao_tributaria = tr.dataset.pisSt || item.pis_situacao_tributaria || '07';
      item.cofins_situacao_tributaria = tr.dataset.cofinsSt || item.cofins_situacao_tributaria || '07';
      item.tipo = tr.dataset.tipo || item.tipo || '';
      item.pis_aliquota_porcentual = tr.dataset.pisAliquotaPorcentual != null && tr.dataset.pisAliquotaPorcentual !== '' ? tr.dataset.pisAliquotaPorcentual : (item.pis_aliquota_porcentual != null ? item.pis_aliquota_porcentual : '');
      item.cofins_aliquota_porcentual = tr.dataset.cofinsAliquotaPorcentual != null && tr.dataset.cofinsAliquotaPorcentual !== '' ? tr.dataset.cofinsAliquotaPorcentual : (item.cofins_aliquota_porcentual != null ? item.cofins_aliquota_porcentual : '');
      item.pis_base_calculo = tr.dataset.pisBaseCalculo != null && tr.dataset.pisBaseCalculo !== '' ? tr.dataset.pisBaseCalculo : (item.pis_base_calculo != null && item.pis_base_calculo !== '' ? item.pis_base_calculo : '100.0000');
      item.cofins_base_calculo = tr.dataset.cofinsBaseCalculo != null && tr.dataset.cofinsBaseCalculo !== '' ? tr.dataset.cofinsBaseCalculo : (item.cofins_base_calculo != null && item.cofins_base_calculo !== '' ? item.cofins_base_calculo : '100.0000');
      item.pis_valor = tr.dataset.pisValor != null && tr.dataset.pisValor !== '' ? tr.dataset.pisValor : (item.pis_valor != null ? item.pis_valor : '');
      item.cofins_valor = tr.dataset.cofinsValor != null && tr.dataset.cofinsValor !== '' ? tr.dataset.cofinsValor : (item.cofins_valor != null ? item.cofins_valor : '');
      item.icms_modalidade_base_calculo = tr.dataset.icmsModalidadeBaseCalculo != null && tr.dataset.icmsModalidadeBaseCalculo !== '' ? tr.dataset.icmsModalidadeBaseCalculo : (item.icms_modalidade_base_calculo != null ? item.icms_modalidade_base_calculo : '');
      item.icms_aliquota = tr.dataset.icmsAliquota != null && tr.dataset.icmsAliquota !== '' ? tr.dataset.icmsAliquota : (item.icms_aliquota != null ? item.icms_aliquota : '');
      item.icms_valor = tr.dataset.icmsValor != null && tr.dataset.icmsValor !== '' ? tr.dataset.icmsValor : (item.icms_valor != null ? item.icms_valor : '');
      item.ipi_situacao_tributaria = tr.dataset.ipiSt != null && tr.dataset.ipiSt !== '' ? tr.dataset.ipiSt : (item.ipi_situacao_tributaria != null ? item.ipi_situacao_tributaria : '53');
      item.ipi_codigo_enquadramento_legal = tr.dataset.ipiCodEnquadramento != null && tr.dataset.ipiCodEnquadramento !== '' ? tr.dataset.ipiCodEnquadramento : (item.ipi_codigo_enquadramento_legal != null && item.ipi_codigo_enquadramento_legal !== '' ? item.ipi_codigo_enquadramento_legal : '');
      item.ipi_valor = tr.dataset.ipiValor != null && tr.dataset.ipiValor !== '' ? tr.dataset.ipiValor : (item.ipi_valor != null ? item.ipi_valor : '');
      item.ipi_aliquota = tr.dataset.ipiAliquota != null && tr.dataset.ipiAliquota !== '' ? tr.dataset.ipiAliquota : (item.ipi_aliquota != null ? item.ipi_aliquota : '');
      item.valor_frete = tr.dataset.valorFrete != null && tr.dataset.valorFrete !== '' ? tr.dataset.valorFrete : (item.valor_frete != null ? item.valor_frete : '0');
      item.unidade_comercial = item.unidade_comercial || 'UN';
      item.unidade_tributavel = item.unidade_tributavel || item.unidade_comercial || 'UN';
      item.quantidade_tributavel = item.quantidade_tributavel != null ? item.quantidade_tributavel : (item.quantidade_comercial || 0);
      item.valor_unitario_tributavel = item.valor_unitario_tributavel != null ? item.valor_unitario_tributavel : (item.valor_unitario_comercial || 0);
      document.querySelectorAll('#sheetItemNF input[data-field], #sheetItemNF select[data-field], #sheetItemNF textarea[data-field]').forEach(function (el) {
        var f = el.getAttribute('data-field');
        if (!f) return;
        var v = item[f];
        if (v !== undefined && v !== null) {
          if (f === 'icms_valor' || f === 'ipi_valor') { var n = parseFloat(v); v = !isNaN(n) ? Math.round(n * 100) / 100 : v; }
          el.value = v;
        }
      });
      var vBruto = (item.quantidade_comercial || 0) * (item.valor_unitario_comercial || 0);
      var vBrutoEl = document.getElementById('sheet_valor_bruto');
      if (vBrutoEl) vBrutoEl.value = Math.round(vBruto * 100) / 100;
      updateSheetPisCofinsValor();
      document.getElementById('sheetItemNF').classList.add('open');
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function updateSheetPisCofinsValor() {
      var valorTotal = parseFloat(document.getElementById('sheet_valor_bruto').value) || 0;
      var basePis = parseFloat(document.getElementById('sheet_pis_base').value) || 100;
      var aliqPis = parseFloat(document.getElementById('sheet_pis_aliquota').value) || 0;
      var baseCofins = parseFloat(document.getElementById('sheet_cofins_base').value) || 100;
      var aliqCofins = parseFloat(document.getElementById('sheet_cofins_aliquota').value) || 0;
      var valorPis = Math.round(valorTotal * (basePis / 100) * (aliqPis / 100) * 100) / 100;
      var valorCofins = Math.round(valorTotal * (baseCofins / 100) * (aliqCofins / 100) * 100) / 100;
      document.getElementById('sheet_pis_valor').value = valorPis;
      document.getElementById('sheet_cofins_valor').value = valorCofins;
    }

    function closeSheetItemNF() {
      document.getElementById('sheetItemNF').classList.remove('open');
      sheetItemNFRow = null;
    }

    function saveSheetItemNF() {
      if (!sheetItemNFRow) return;
      var tr = sheetItemNFRow;
      document.querySelectorAll('#sheetItemNF input, #sheetItemNF select, #sheetItemNF textarea').forEach(function (el) {
        var f = el.getAttribute('data-field');
        if (!f) return;
        var inp = tr.querySelector('input[data-field="' + f + '"]');
        if (inp) inp.value = el.value;
      });
      var qtd = parseFloat(document.getElementById('sheet_quantidade_comercial').value) || 0;
      var vUnit = parseFloat(document.getElementById('sheet_valor_unitario_comercial').value) || 0;
      var qtdInp = tr.querySelector('input[data-field="quantidade_comercial"]');
      var vUnitInp = tr.querySelector('input[data-field="valor_unitario_comercial"]');
      if (qtdInp) qtdInp.value = qtd;
      if (vUnitInp) vUnitInp.value = vUnit;
      var descInp = tr.querySelector('input[data-field="descricao"]');
      var codInp = tr.querySelector('input[data-field="codigo_produto"]');
      var ncmInp = tr.querySelector('input[data-field="codigo_ncm"]');
      var unInp = tr.querySelector('input[data-field="unidade_comercial"]');
      if (descInp) descInp.value = document.getElementById('sheet_descricao').value || '';
      if (codInp) codInp.value = document.getElementById('sheet_codigo_produto').value || '';
      if (ncmInp) ncmInp.value = (document.getElementById('sheet_codigo_ncm').value || '').replace(/\D/g, '').padStart(8, '0').slice(0, 8) || '00000000';
      if (unInp) unInp.value = document.getElementById('sheet_unidade_comercial').value || 'UN';
      tr.dataset.icmsSt = document.getElementById('sheet_icms_situacao_tributaria').value || '400';
      tr.dataset.icmsOrigem = document.getElementById('sheet_icms_origem').value || '0';
      tr.dataset.pisSt = document.getElementById('sheet_pis_situacao_tributaria').value || '07';
      tr.dataset.cofinsSt = document.getElementById('sheet_cofins_situacao_tributaria').value || '07';
      tr.dataset.cfop = document.getElementById('sheet_cfop').value || '5102';
      tr.dataset.tipo = document.getElementById('sheet_tipo').value || '';
      tr.dataset.pisAliquotaPorcentual = document.getElementById('sheet_pis_aliquota').value || '';
      tr.dataset.cofinsAliquotaPorcentual = document.getElementById('sheet_cofins_aliquota').value || '';
      tr.dataset.pisBaseCalculo = document.getElementById('sheet_pis_base').value || '';
      tr.dataset.cofinsBaseCalculo = document.getElementById('sheet_cofins_base').value || '';
      tr.dataset.pisValor = document.getElementById('sheet_pis_valor').value || '';
      tr.dataset.cofinsValor = document.getElementById('sheet_cofins_valor').value || '';
      tr.dataset.icmsModalidadeBaseCalculo = document.getElementById('sheet_icms_modalidade_bc').value || '';
      tr.dataset.icmsAliquota = document.getElementById('sheet_icms_aliquota').value || '';
      var icmsVal = parseFloat(document.getElementById('sheet_icms_valor').value);
      tr.dataset.icmsValor = !isNaN(icmsVal) ? String(Math.round(icmsVal * 100) / 100) : '';
      tr.dataset.ipiSt = document.getElementById('sheet_ipi_situacao_tributaria').value || '53';
      tr.dataset.ipiCodEnquadramento = document.getElementById('sheet_ipi_codigo_enquadramento').value || '';
      var ipiVal = parseFloat(document.getElementById('sheet_ipi_valor').value);
      tr.dataset.ipiValor = !isNaN(ipiVal) ? String(Math.round(ipiVal * 100) / 100) : '';
      var freteVal = parseFloat(document.getElementById('sheet_valor_frete').value);
      tr.dataset.valorFrete = !isNaN(freteVal) ? String(Math.round(freteVal * 100) / 100) : '0';
      updateValorBruto(tr);
      updateModalCalcTotais();
      closeSheetItemNF();
    }

    document.getElementById('sheetItemNFClose').addEventListener('click', closeSheetItemNF);
    document.getElementById('sheetItemNFCancel').addEventListener('click', closeSheetItemNF);
    document.getElementById('sheetItemNFSave').addEventListener('click', saveSheetItemNF);
    document.getElementById('sheetItemNF').addEventListener('click', function (e) {
      if (e.target === this) closeSheetItemNF();
    });
    document.querySelectorAll('#sheetTabs .sheet-tab').forEach(function (tab) {
      tab.addEventListener('click', function () {
        var t = this.getAttribute('data-tab');
        document.querySelectorAll('#sheetTabs .sheet-tab').forEach(function (x) { x.classList.remove('active'); });
        document.querySelectorAll('.sheet-tab-content').forEach(function (x) { x.classList.remove('active'); });
        this.classList.add('active');
        var content = document.getElementById('sheetTab' + t.charAt(0).toUpperCase() + t.slice(1));
        if (content) content.classList.add('active');
      });
    });
    document.getElementById('sheet_quantidade_comercial').addEventListener('input', function () {
      var q = parseFloat(this.value) || 0;
      var v = parseFloat(document.getElementById('sheet_valor_unitario_comercial').value) || 0;
      document.getElementById('sheet_valor_bruto').value = Math.round(q * v * 100) / 100;
      updateSheetPisCofinsValor();
    });
    document.getElementById('sheet_valor_unitario_comercial').addEventListener('input', function () {
      var q = parseFloat(document.getElementById('sheet_quantidade_comercial').value) || 0;
      var v = parseFloat(this.value) || 0;
      document.getElementById('sheet_valor_bruto').value = Math.round(q * v * 100) / 100;
      updateSheetPisCofinsValor();
    });
    document.getElementById('sheet_pis_base').addEventListener('input', updateSheetPisCofinsValor);
    document.getElementById('sheet_pis_aliquota').addEventListener('input', updateSheetPisCofinsValor);
    document.getElementById('sheet_cofins_base').addEventListener('input', updateSheetPisCofinsValor);
    document.getElementById('sheet_cofins_aliquota').addEventListener('input', updateSheetPisCofinsValor);
    document.getElementById('sheet_icms_valor').addEventListener('blur', function () {
      var v = parseFloat(this.value);
      if (!isNaN(v)) this.value = Math.round(v * 100) / 100;
    });

    document.getElementById('btnAdicionarItemNF').addEventListener('click', function () {
      addItemRow({}, null);
    });
    var btnGerarParcelas = document.getElementById('btnGerarParcelas');
    if (btnGerarParcelas) btnGerarParcelas.addEventListener('click', function () {
      setModalNFMessage('Gerar parcelas: em desenvolvimento.', 'info');
    });

    function applyCalcAutoInputsState() {
      var toggle = document.getElementById('nfCalcAutoToggle');
      var container = document.getElementById('calcImpostoInputs');
      if (!toggle || !container) return;
      var isOn = toggle.classList.contains('on');
      container.querySelectorAll('input').forEach(function (inp) {
        inp.readOnly = isOn;
        inp.classList.toggle('calc-auto-readonly', isOn);
      });
    }
    (function () {
      var toggle = document.getElementById('nfCalcAutoToggle');
      var label = document.getElementById('nfCalcAutoLabel');
      if (toggle && label) {
        applyCalcAutoInputsState();
        toggle.addEventListener('click', function () {
          toggle.classList.toggle('on');
          label.textContent = toggle.classList.contains('on') ? 'Ativado' : 'Desativado';
          toggle.setAttribute('aria-checked', toggle.classList.contains('on') ? 'true' : 'false');
          applyCalcAutoInputsState();
          if (toggle.classList.contains('on')) updateModalCalcTotais();
        });
      }
      var freteEl = document.getElementById('nf_valor_frete');
      var descEl = document.getElementById('nf_valor_desconto');
      if (freteEl) freteEl.addEventListener('input', updateModalCalcTotais);
      if (descEl) descEl.addEventListener('input', updateModalCalcTotais);
      var infoNaturezaEl = document.getElementById('nf_info_complementares_natureza');
      if (infoNaturezaEl) {
        infoNaturezaEl.addEventListener('input', updateModalCalcTotais);
        infoNaturezaEl.addEventListener('blur', updateModalCalcTotais);
      }
    })();

    function getPayloadFromForm() {
      var get = function (id) { var el = document.getElementById(id); return el ? el.value.trim() : ''; };
      var tipoPessoa = get('nf_tipo_pessoa_dest');
      var cpfCnpj = onlyNumbers(get('nf_cpf_cnpj_dest'));
      var payload = {
        natureza_operacao: get('nf_natureza_operacao') || 'Venda de mercadoria',
        data_emissao: get('nf_data_emissao'),
        data_entrada_saida: get('nf_data_entrada_saida'),
        finalidade_emissao: get('nf_finalidade_emissao') || '1',
        tipo_documento: '1',
        consumidor_final: get('nf_consumidor_final') || '1',
        presenca_comprador: get('nf_presenca_comprador') || '2',
        local_destino: parseInt(get('nf_local_destino'), 10) || 1,
        indicador_inscricao_estadual_destinatario: parseInt(get('nf_indicador_ie_dest'), 10) || 9,
        cnpj_emitente: onlyNumbers(get('nf_cnpj_emitente')),
        nome_emitente: get('nf_nome_emitente'),
        nome_fantasia_emitente: get('nf_nome_fantasia_emitente') || undefined,
        logradouro_emitente: get('nf_logradouro_emitente'),
        numero_emitente: get('nf_numero_emitente') || 'S/N',
        bairro_emitente: get('nf_bairro_emitente'),
        municipio_emitente: get('nf_municipio_emitente'),
        uf_emitente: get('nf_uf_emitente') || 'MG',
        cep_emitente: onlyNumbers(get('nf_cep_emitente')).padStart(8, '0').slice(0, 8) || '00000000',
        inscricao_estadual_emitente: get('nf_inscricao_estadual_emitente'),
        telefone_emitente: get('nf_telefone_emitente') || undefined,
        nome_destinatario: get('nf_nome_destinatario'),
        inscricao_estadual_destinatario: get('nf_inscricao_estadual_destinatario') || 'ISENTO',
        logradouro_destinatario: get('nf_logradouro_destinatario'),
        numero_destinatario: get('nf_numero_destinatario') || 'S/N',
        bairro_destinatario: get('nf_bairro_destinatario'),
        municipio_destinatario: get('nf_municipio_destinatario'),
        uf_destinatario: get('nf_uf_destinatario') || 'EX',
        pais_destinatario: get('nf_pais_destinatario') || 'Brasil',
        cep_destinatario: onlyNumbers(get('nf_cep_destinatario')).padStart(8, '0').slice(0, 8) || '00000000',
        valor_frete: parseFloat(get('nf_valor_frete')) || 0,
        valor_seguro: 0,
        valor_total: parseFloat(get('nf_valor_total')) || 0,
        valor_produtos: parseFloat(get('nf_valor_produtos')) || 0,
        modalidade_frete: '0',
        items: []
      };
      if (tipoPessoa === 'pf' && cpfCnpj.length === 11) payload.cpf_destinatario = cpfCnpj;
      else if (tipoPessoa === 'pj' && cpfCnpj.length === 14) payload.cnpj_destinatario = cpfCnpj;
      var telDest = get('nf_telefone_destinatario');
      if (telDest) payload.telefone_destinatario = telDest;
      var desc = parseFloat(get('nf_valor_desconto'));
      if (desc > 0) payload.valor_desconto = desc;
      var totalIs = parseFloat(get('nf_total_is'));
      var totalIbs = parseFloat(get('nf_total_ibs'));
      var totalCbs = parseFloat(get('nf_total_cbs'));
      if (!isNaN(totalIs) && totalIs > 0) payload.total_is = totalIs;
      if (!isNaN(totalIbs) && totalIbs > 0) payload.total_ibs = totalIbs;
      if (!isNaN(totalCbs) && totalCbs > 0) payload.total_cbs = totalCbs;
      var tbody = document.getElementById('nfItemsBody');
      tbody.querySelectorAll('tr').forEach(function (tr, idx) {
        var inputs = tr.querySelectorAll('input[data-field]');
        var item = {
          numero_item: String(idx + 1),
          codigo_produto: '',
          descricao: 'Item',
          cfop: tr.dataset.cfop || '5102',
          unidade_comercial: 'UN',
          quantidade_comercial: 0,
          valor_unitario_comercial: 0,
          codigo_ncm: '00000000',
          valor_bruto: 0,
          icms_situacao_tributaria: tr.dataset.icmsSt || '400',
          icms_origem: tr.dataset.icmsOrigem || '0',
          pis_situacao_tributaria: tr.dataset.pisSt || '07',
          cofins_situacao_tributaria: tr.dataset.cofinsSt || '07'
        };
        if (tr.dataset.tipo) item.tipo = tr.dataset.tipo;
        if (tr.dataset.pisAliquotaPorcentual) item.pis_aliquota_porcentual = parseFloat(tr.dataset.pisAliquotaPorcentual) || 0;
        if (tr.dataset.cofinsAliquotaPorcentual) item.cofins_aliquota_porcentual = parseFloat(tr.dataset.cofinsAliquotaPorcentual) || 0;
        if (tr.dataset.pisBaseCalculo) item.pis_base_calculo = parseFloat(tr.dataset.pisBaseCalculo) || 0;
        if (tr.dataset.cofinsBaseCalculo) item.cofins_base_calculo = parseFloat(tr.dataset.cofinsBaseCalculo) || 0;
        if (tr.dataset.pisValor) item.pis_valor = parseFloat(tr.dataset.pisValor) || 0;
        if (tr.dataset.cofinsValor) item.cofins_valor = parseFloat(tr.dataset.cofinsValor) || 0;
        if (tr.dataset.icmsModalidadeBaseCalculo) item.icms_modalidade_base_calculo = tr.dataset.icmsModalidadeBaseCalculo;
        if (tr.dataset.icmsAliquota) item.icms_aliquota = parseFloat(tr.dataset.icmsAliquota) || 0;
        if (tr.dataset.icmsValor) item.icms_valor = Math.round((parseFloat(tr.dataset.icmsValor) || 0) * 100) / 100;
        if (tr.dataset.valorFrete != null && tr.dataset.valorFrete !== '') item.valor_frete = Math.round((parseFloat(tr.dataset.valorFrete) || 0) * 100) / 100;
        /* IPI omitido: a maioria dos produtos não é sujeita a IPI. Incluir ipi_* gera erro 422 (IPINT inesperado). */
        inputs.forEach(function (inp) {
          var f = inp.getAttribute('data-field');
          var v = inp.value.trim();
          var n = parseFloat(v);
          if (f === 'quantidade_comercial') item[f] = isNaN(n) ? 0 : n;
          else if (f === 'valor_unitario_comercial') item[f] = isNaN(n) ? 0 : Math.round(n * 100) / 100;
          else if (f === 'codigo_ncm') item[f] = onlyNumbers(v).padStart(8, '0').slice(0, 8) || '00000000';
          else if (v) item[f] = v;
        });
        item.valor_unitario_tributavel = item.valor_unitario_comercial;
        item.unidade_tributavel = item.unidade_comercial || 'UN';
        item.quantidade_tributavel = item.quantidade_comercial;
        item.valor_bruto = Math.round((item.quantidade_comercial || 0) * (item.valor_unitario_comercial || 0) * 100) / 100;
        item.cfop = tr.dataset.cfop || item.cfop || '5102';
        payload.items.push(item);
      });
      return payload;
    }

    function openModalAdicionarNF() {
      resetModalNF();
      var pedidoId = document.getElementById('pedidoId').value.trim();
      var empresaId = document.getElementById('empresaId').value.trim();
      var naturezaId = document.getElementById('naturezaId').value.trim();
      pedidoId = pedidoId ? parseInt(pedidoId, 10) : 0;
      empresaId = empresaId ? parseInt(empresaId, 10) : 0;
      naturezaId = naturezaId ? parseInt(naturezaId, 10) : 0;
      var overlay = document.getElementById('modalAdicionarNF');
      overlay.classList.add('open');
      if (!pedidoId || pedidoId < 1) {
        setModalNFMessage('Selecione o ID do pedido no formulário "Emitir NFe" abaixo.', 'error');
        return;
      }
      if (!empresaId || empresaId < 1) {
        setModalNFMessage('Selecione a empresa no formulário "Emitir NFe" abaixo.', 'error');
        return;
      }
      if (!naturezaId || naturezaId < 1) {
        setModalNFMessage('Selecione a natureza de operação no formulário "Emitir NFe" abaixo.', 'error');
        return;
      }
      modalNFContext = { pedidoId: pedidoId, empresaId: empresaId, naturezaId: naturezaId };
      setModalNFMessage('Carregando…', 'info');
      // Resolve automaticamente o cliente a partir do pedido (pedido -> contato -> nome).
      resolveClienteFromPedido(pedidoId);
      fetch(API + '/fiscal/preview-chamada', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ pedidoId: pedidoId, empresa_id: empresaId, natureza_operacao_id: naturezaId })
      })
        .then(function (r) { return r.json().then(function (d) { return { ok: r.ok, data: d }; }); })
        .then(function (preview) {
          if (preview.ok && preview.data && (Array.isArray(preview.data.items) || Array.isArray(preview.data.itens))) {
            fillFormFromPayload(preview.data);
            setModalNFMessage('');
          } else {
            setModalNFMessage(preview.data && (preview.data.message || preview.data.detail) ? (preview.data.message || preview.data.detail) : 'Não foi possível carregar os dados da nota.', 'error');
          }
        })
        .catch(function (e) {
          setModalNFMessage('Erro: ' + (e.message || 'ao carregar'), 'error');
        });
    }
    var fpDataEmissao, fpDataEntradaSaida;
    (function initFlatpickr() {
      var fpOpts = {
        enableTime: true,
        time_24hr: true,
        enableSeconds: true,
        minuteIncrement: 1,
        locale: 'pt',
        dateFormat: 'Y-m-d\\TH:i:S',
        altInput: true,
        altFormat: 'd/m/Y, H:i:S',
        altInputClass: 'form-datetime-alt',
        allowInput: false
      };
      fpDataEmissao = flatpickr('#nf_data_emissao', fpOpts);
      fpDataEntradaSaida = flatpickr('#nf_data_entrada_saida', fpOpts);
    })();
    document.getElementById('modalAdicionarNFClose').addEventListener('click', function () {
      document.getElementById('modalAdicionarNF').classList.remove('open');
    });
    document.getElementById('nf_cep_emitente').addEventListener('blur', function () {
      buscaCep('nf_cep_emitente', 'nf_logradouro_emitente', 'nf_bairro_emitente', 'nf_municipio_emitente', 'nf_uf_emitente');
    });
    document.getElementById('nf_cep_destinatario').addEventListener('blur', function () {
      buscaCep('nf_cep_destinatario', 'nf_logradouro_destinatario', 'nf_bairro_destinatario', 'nf_municipio_destinatario', 'nf_uf_destinatario');
    });
    (function initDocDestinatario() {
      var tipoSel = document.getElementById('nf_tipo_pessoa_dest');
      var docInp = document.getElementById('nf_cpf_cnpj_dest');
      if (!tipoSel || !docInp) return;
      tipoSel.addEventListener('change', function () {
        docInp.value = '';
        updateDocDestUI();
      });
      docInp.addEventListener('input', function () {
        var tipo = tipoSel.value;
        if (tipo === 'pf') docInp.value = maskCPF(docInp.value);
        else if (tipo === 'pj') docInp.value = maskCNPJ(docInp.value);
        else docInp.value = onlyNumbers(docInp.value).slice(0, 14);
        clearDocDestError();
      });
      docInp.addEventListener('blur', function () {
        var r = validateDocDest();
        if (!r.valid && r.error) setDocDestError(r.error);
      });
    })();
    (function initClienteField() {
      var inputEl = document.getElementById('nf_cliente_busca');
      var listEl = document.getElementById('nf_cliente_contatos_list');
      var btnEl = document.getElementById('nf_cliente_btn_add_edit');
      if (!inputEl || !listEl || !btnEl) return;

      // Campo "Cliente" é somente exibição (derivado do pedido -> contato).
      inputEl.setAttribute('readonly', 'readonly');
      function hideList() { listEl.innerHTML = ''; listEl.style.display = 'none'; }
      hideList();

      inputEl.addEventListener('focus', hideList);
      inputEl.addEventListener('keydown', function (e) {
        // Mantém navegação (Tab/setas) funcionando, mas evita tentativa de edição.
        var allow = ['Tab', 'Escape', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'];
        if (allow.indexOf(e.key) !== -1) return;
        e.preventDefault();
      });
      inputEl.addEventListener('paste', function (e) { e.preventDefault(); });

      btnEl.addEventListener('click', function () {
        if (selectedContatoId) {
          fetch(API + '/fiscal/contatos/' + selectedContatoId)
            .then(function (r) { return r.json(); })
            .then(function (c) {
              if (c && typeof c === 'object') {
                var cliente = {
                  id: c.contato_id || c.id,
                  nome_fantasia: c.nome_fantasia || c.nome,
                  razao_social: c.razao_social || c.nome,
                  cnpj: (c.cpf_cnpj || '').toString().replace(/\D/g, ''),
                  tipo_pessoa: (c.cpf_cnpj || '').toString().replace(/\D/g, '').length === 14 ? 'pj' : 'pf',
                  inscricao_estadual: c.ie,
                  email: c.email,
                  telefone_celular: c.celular,
                  telefone_comercial: c.telefoneFixo,
                  endereco_entrega: c.logradouro || c.cep ? { rua: c.logradouro, numero: c.numero, bairro: c.bairro, cidade: c.municipio, uf: c.uf, cep: (c.cep || '').toString().replace(/\D/g, '') } : {}
                };
                openModalCliente(cliente);
              }
            })
            .catch(function () { });
        } else {
          // Sem contato resolvido: permite criar um contato, mas o vínculo ao pedido é externo ao formulário.
          openModalCliente();
        }
      });
    })();
    document.getElementById('modalAdicionarNF').addEventListener('click', function (e) {
      if (e.target === this) this.classList.remove('open');
    });
    document.getElementById('btnEmitirNF').addEventListener('click', async function () {
      var docValidation = validateDocDest();
      if (!docValidation.valid) {
        setDocDestError(docValidation.error);
        setModalNFMessage(docValidation.error || 'Verifique o documento do destinatário.', 'error');
        return;
      }
      clearDocDestError();
      // Garante "Cliente" (nome_destinatario) resolvido via pedido -> contato.
      var nomeDestEl = document.getElementById('nf_nome_destinatario');
      if ((!nomeDestEl || !nomeDestEl.value.trim()) && modalNFContext && modalNFContext.pedidoId) {
        await resolveClienteFromPedido(modalNFContext.pedidoId);
      }
      nomeDestEl = document.getElementById('nf_nome_destinatario');
      if (!nomeDestEl || !nomeDestEl.value.trim()) {
        setModalNFMessage('Não foi possível resolver o cliente do pedido. Verifique o pedido_id e o contato vinculado.', 'error');
        return;
      }
      var payload = getPayloadFromForm();
      if (!payload.items || payload.items.length === 0) {
        setModalNFMessage('Adicione ao menos um produto.', 'error');
        return;
      }
      var btn = document.getElementById('btnEmitirNF');
      setModalNFMessage('');
      btn.disabled = true;
      btn.textContent = 'Emitindo…';
      try {
        var res = await fetch(API + '/fiscal/emitir-payload', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            pedido_id: modalNFContext.pedidoId,
            empresa_id: modalNFContext.empresaId,
            natureza_operacao_id: modalNFContext.naturezaId,
            payload: payload
          }),
        });
        var data = await res.json();
        if (!res.ok) {
          setModalNFMessage(data.message || data.detail || 'Erro ao emitir.', 'error');
          return;
        }
        setModalNFMessage(
          data.mensagem + (data.invoiceId ? ' Invoice: ' + data.invoiceId : '') + (data.focus_id ? ' | Ref: ' + data.focus_id : ''),
          'success'
        );
        loadInvoices();
        setTimeout(function () {
          document.getElementById('modalAdicionarNF').classList.remove('open');
        }, 1500);
      } catch (e) {
        setModalNFMessage('Erro de rede: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Salvar';
      }
    });

    var clienteEnderecos = { comercial: {}, residencial: {}, entrega: {}, nota_fiscal: {} };
    function formatEnderecoDisplay(obj) {
      if (!obj || (!obj.rua && !obj.cep)) return null;
      var parts = [];
      if (obj.rua && obj.numero) parts.push(obj.rua + ', ' + obj.numero);
      else if (obj.rua) parts.push(obj.rua);
      if (obj.bairro && obj.cep) parts.push(obj.bairro + ' - ' + obj.cep);
      else if (obj.bairro) parts.push(obj.bairro);
      else if (obj.cep) parts.push(obj.cep);
      if (obj.cidade && obj.uf) parts.push(obj.cidade + ' - ' + obj.uf);
      return parts.length ? parts.join('\n') : null;
    }
    function showClienteView(view) {
      var formView = document.getElementById('sheetClienteViewForm');
      var endView = document.getElementById('sheetClienteViewEndereco');
      var footerForm = document.getElementById('sheetClienteFooterForm');
      var footerEnd = document.getElementById('sheetClienteFooterEndereco');
      if (view === 'endereco') {
        formView.classList.remove('active');
        endView.classList.add('active');
        footerForm.style.display = 'none';
        footerEnd.style.display = 'flex';
      } else {
        endView.classList.remove('active');
        formView.classList.add('active');
        footerEnd.style.display = 'none';
        footerForm.style.display = 'flex';
      }
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    function openModalCliente(cliente) {
      cliente = cliente || {};
      document.getElementById('cliente_nome_fantasia').value = cliente.nome_fantasia || '';
      document.getElementById('cliente_tipo_pessoa').value = cliente.tipo_pessoa || 'pj';
      document.getElementById('cliente_cnpj').value = cliente.cnpj || '';
      document.getElementById('cliente_razao_social').value = cliente.razao_social || '';
      document.getElementById('cliente_tipo_contribuinte').value = cliente.tipo_contribuinte || '9';
      document.getElementById('cliente_inscricao_estadual').value = cliente.inscricao_estadual || '';
      document.getElementById('cliente_email').value = cliente.email || '';
      document.getElementById('cliente_telefone_celular').value = cliente.telefone_celular || '';
      document.getElementById('cliente_telefone_comercial').value = cliente.telefone_comercial || '';
      clienteEnderecos = {
        comercial: cliente.endereco_comercial || {},
        residencial: cliente.endereco_residencial || {},
        entrega: cliente.endereco_entrega || {},
        nota_fiscal: cliente.endereco_nota_fiscal || {}
      };
      var tipos = ['comercial', 'residencial', 'entrega', 'nota_fiscal'];
      var labels = { comercial: 'Comercial', residencial: 'Residencial', entrega: 'Entrega', nota_fiscal: 'NotaFiscal' };
      tipos.forEach(function (t) {
        var disp = document.getElementById('clienteEndereco' + labels[t] + 'Display');
        var card = document.querySelector('.cliente-endereco-card[data-tipo="' + t + '"]');
        if (disp) {
          var txt = formatEnderecoDisplay(clienteEnderecos[t]);
          disp.textContent = txt || 'Clique em editar para preencher o endereço';
          disp.classList.toggle('empty', !txt);
        }
        if (card) {
          var temEndereco = !!formatEnderecoDisplay(clienteEnderecos[t]);
          card.style.display = temEndereco ? '' : 'none';
        }
      });
      var addCard = document.getElementById('clienteEnderecoCardAdd');
      if (addCard) addCard.style.display = 'flex';
      document.getElementById('sheetClienteTitle').textContent = cliente.id ? 'Editar cliente' : 'Novo cliente';
      showClienteView('form');
      document.getElementById('sheetCliente').classList.add('open');
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    function openModalClienteEndereco(tipo) {
      var end = clienteEnderecos[tipo] || {};
      document.getElementById('cliente_endereco_tipo').value = tipo;
      document.getElementById('cliente_end_tipo').value = tipo;
      document.getElementById('cliente_end_cep').value = end.cep || '';
      document.getElementById('cliente_end_rua').value = end.rua || '';
      document.getElementById('cliente_end_numero').value = end.numero || '';
      document.getElementById('cliente_end_complemento').value = end.complemento || '';
      document.getElementById('cliente_end_bairro').value = end.bairro || '';
      document.getElementById('cliente_end_cidade').value = end.cidade || '';
      document.getElementById('cliente_end_uf').value = end.uf || '';
      showClienteView('endereco');
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    function saveClienteEndereco() {
      var tipo = document.getElementById('cliente_endereco_tipo').value;
      clienteEnderecos[tipo] = {
        cep: document.getElementById('cliente_end_cep').value.trim(),
        rua: document.getElementById('cliente_end_rua').value.trim(),
        numero: document.getElementById('cliente_end_numero').value.trim(),
        complemento: document.getElementById('cliente_end_complemento').value.trim(),
        bairro: document.getElementById('cliente_end_bairro').value.trim(),
        cidade: document.getElementById('cliente_end_cidade').value.trim(),
        uf: document.getElementById('cliente_end_uf').value
      };
      var labels = { comercial: 'Comercial', residencial: 'Residencial', entrega: 'Entrega', nota_fiscal: 'NotaFiscal' };
      var disp = document.getElementById('clienteEndereco' + (labels[tipo] || tipo) + 'Display');
      var txt = formatEnderecoDisplay(clienteEnderecos[tipo]);
      disp.textContent = txt || 'Clique em editar para preencher o endereço';
      disp.classList.toggle('empty', !txt);
      var card = document.querySelector('.cliente-endereco-card[data-tipo="' + tipo + '"]');
      if (card && txt) card.style.display = '';
      showClienteView('form');
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }
    function openModalClienteFromInvoice(invoiceId) {
      fetch(API + '/fiscal/' + invoiceId + '/chamada')
        .then(function (r) { return r.json(); })
        .then(function (p) {
          var cliente = {};
          if (p && typeof p === 'object' && !p.message) {
            cliente.nome_fantasia = p.nome_destinatario || p.nome_fantasia_destinatario || '';
            cliente.razao_social = p.razao_social_destinatario || p.nome_destinatario || '';
            cliente.cnpj = (p.cnpj_destinatario || '').toString().replace(/\D/g, '');
            cliente.tipo_pessoa = cliente.cnpj.length === 14 ? 'pj' : 'pf';
            cliente.inscricao_estadual = p.inscricao_estadual_destinatario || '';
            cliente.tipo_contribuinte = String(p.indicador_inscricao_estadual_destinatario || '9');
            cliente.telefone_celular = p.telefone_destinatario || '';
            cliente.telefone_comercial = p.telefone_destinatario || '';
            cliente.email = p.email_destinatario || '';
            if (p.logradouro_destinatario || p.cep_destinatario) {
              cliente.endereco_nota_fiscal = cliente.endereco_entrega = {
                rua: p.logradouro_destinatario || '',
                numero: (p.numero_destinatario || '').toString(),
                complemento: (p.complemento_destinatario || '').toString(),
                bairro: p.bairro_destinatario || '',
                cidade: p.municipio_destinatario || '',
                uf: p.uf_destinatario || '',
                cep: (p.cep_destinatario || '').toString().replace(/\D/g, '')
              };
            }
          }
          openModalCliente(cliente);
        })
        .catch(function () { openModalCliente({}); });
    }
    document.getElementById('sheetClienteClose').addEventListener('click', function () {
      document.getElementById('sheetCliente').classList.remove('open');
    });
    document.getElementById('sheetCliente').addEventListener('click', function (e) {
      if (e.target === this) this.classList.remove('open');
    });
    document.getElementById('btnClienteCancelar').addEventListener('click', function () {
      document.getElementById('sheetCliente').classList.remove('open');
    });
    document.getElementById('btnClienteSalvar').addEventListener('click', function () {
      var payload = {
        nome_fantasia: document.getElementById('cliente_nome_fantasia').value.trim(),
        tipo_pessoa: document.getElementById('cliente_tipo_pessoa').value,
        cnpj: document.getElementById('cliente_cnpj').value.replace(/\D/g, ''),
        razao_social: document.getElementById('cliente_razao_social').value.trim(),
        tipo_contribuinte: document.getElementById('cliente_tipo_contribuinte').value,
        inscricao_estadual: document.getElementById('cliente_inscricao_estadual').value.trim(),
        email: document.getElementById('cliente_email').value.trim(),
        telefone_celular: document.getElementById('cliente_telefone_celular').value.trim(),
        telefone_comercial: document.getElementById('cliente_telefone_comercial').value.trim(),
        endereco_comercial: clienteEnderecos.comercial,
        endereco_residencial: clienteEnderecos.residencial,
        endereco_entrega: clienteEnderecos.entrega,
        endereco_nota_fiscal: clienteEnderecos.nota_fiscal
      };
      console.log('Salvar cliente:', payload);
      document.getElementById('sheetCliente').classList.remove('open');
    });
    document.querySelectorAll('.btn-edit-endereco').forEach(function (btn) {
      btn.addEventListener('click', function () {
        openModalClienteEndereco(this.getAttribute('data-tipo'));
      });
    });
    var addCardEl = document.getElementById('clienteEnderecoCardAdd');
    if (addCardEl) {
      addCardEl.addEventListener('click', function () { openModalClienteEndereco('entrega'); });
      addCardEl.addEventListener('keydown', function (e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openModalClienteEndereco('entrega'); } });
    }
    document.getElementById('btnClienteEnderecoVoltar').addEventListener('click', function () {
      showClienteView('form');
    });
    document.getElementById('btnClienteEnderecoSalvar').addEventListener('click', function () {
      saveClienteEndereco();
    });
    document.getElementById('btnClienteBuscarCnpj').addEventListener('click', function () {
      var cnpj = document.getElementById('cliente_cnpj').value.replace(/\D/g, '');
      if (cnpj.length !== 14) return;
      fetch('https://brasilapi.com.br/api/cnpj/v1/' + cnpj)
        .then(function (r) { return r.json(); })
        .then(function (d) {
          if (d.razao_social) {
            document.getElementById('cliente_razao_social').value = d.razao_social || '';
            document.getElementById('cliente_nome_fantasia').value = d.nome_fantasia || d.razao_social || '';
          }
        })
        .catch(function () { });
    });

    async function emitir() {
      const pedidoId = document.getElementById('pedidoId').value.trim();
      const empresaId = document.getElementById('empresaId').value.trim();
      const naturezaId = document.getElementById('naturezaId').value.trim();
      const btn = document.getElementById('btnEmitir');
      const msgEl = document.getElementById('emitirMessage');
      if (!pedidoId || parseInt(pedidoId, 10) < 1) {
        showMessage('emitirMessage', 'Informe um ID de pedido válido.', 'error');
        return;
      }
      if (btn) btn.disabled = true;
      msgEl.style.display = 'none';
      try {
        const body = {};
        if (empresaId) body.empresa_id = parseInt(empresaId, 10);
        if (naturezaId) body.natureza_operacao_id = parseInt(naturezaId, 10);
        const res = await fetch(API + '/fiscal/emitir/' + pedidoId, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });
        const data = await res.json();
        if (!res.ok) {
          showMessage('emitirMessage', data.message || 'Erro ao emitir.', 'error');
          return;
        }
        showMessage(
          'emitirMessage',
          data.mensagem + ' Invoice: ' + data.invoiceId + (data.focus_id ? ' | Ref: ' + data.focus_id : ''),
          'success'
        );
        loadInvoices();
      } catch (e) {
        showMessage('emitirMessage', 'Erro de rede: ' + e.message, 'error');
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    async function loadEmpresas() {
      const sel = document.getElementById('empresaId');
      try {
        const res = await fetch(API + '/fiscal/empresas');
        const data = await res.json();
        if (!res.ok) {
          const msg = (data && (data.detail || data.message)) || res.status;
          sel.innerHTML = '<option value="">Erro: ' + msg + '</option>';
          return;
        }
        const list = Array.isArray(data) ? data : [];
        sel.innerHTML = '<option value="">Selecionar</option>' +
          list.map(function (e) {
            return '<option value="' + e.id + '">' + (e.razao_social || '') + '</option>';
          }).join('');
      } catch (e) {
        sel.innerHTML = '<option value="">Erro de rede</option>';
      }
    }

    async function loadNaturezas() {
      const sel = document.getElementById('naturezaId');
      try {
        const res = await fetch(API + '/fiscal/naturezas');
        const data = await res.json();
        if (!res.ok) {
          const msg = (data && (data.detail || data.message)) || res.status;
          sel.innerHTML = '<option value="">Erro: ' + msg + '</option>';
          return;
        }
        const list = Array.isArray(data) ? data : [];
        sel.innerHTML = '<option value="">Selecionar</option>' +
          list.map(function (n) {
            return '<option value="' + n.id + '">' + n.descricao + '</option>';
          }).join('');
      } catch (e) {
        sel.innerHTML = '<option value="">Erro de rede</option>';
      }
    }

    var currentInvoicePage = 1;
    var invoicesPerPage = 20;
    var totalInvoicesCount = 0;
    var totalInvoicesPages = 0;
    function getInvoiceListSkeletonHtml() {
      var row = '<tr><td><div class="skeleton-bar short"></div></td><td><div class="skeleton-bar medium"></div></td><td><div class="skeleton-bar long"></div></td><td><div class="skeleton-bar medium"></div></td><td><div class="skeleton-bar short"></div></td><td><div class="skeleton-bar short"></div></td></tr>';
      return '<table class="skeleton-table"><thead><tr><th>Número</th><th>Data emissão</th><th>Nome</th><th>Situação</th><th>Valor (R$)</th><th></th></tr></thead><tbody>' + (row.repeat(5)) + '</tbody></table>';
    }
    function renderInvoiceTable(list) {
      const wrap = document.getElementById('invoiceList');
      if (!wrap) return;
      if (!list || !list.length) {
        wrap.innerHTML = '<div class="empty">Nenhuma nota encontrada com os filtros atuais.</div>';
        return;
      }
      const base = window.location.origin;
      wrap.innerHTML =
        '<table><thead><tr><th>Número</th><th>Data emissão</th><th>Nome</th><th>Situação</th><th>Valor (R$)</th><th></th></tr></thead><tbody>' +
        list.map(function (inv) {
          const dataEmissao = inv.data_emissao
            ? new Date(inv.data_emissao).toLocaleDateString('pt-BR')
            : (inv.created_at ? new Date(inv.created_at).toLocaleDateString('pt-BR') : '-');
          const valor = inv.valor_total != null
            ? Number(inv.valor_total).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
            : '-';
          return (
            '<tr>' +
            '<td>' + (inv.numero_nf != null ? inv.numero_nf : '-') + '</td>' +
            '<td>' + dataEmissao + '</td>' +
            '<td><span class="cliente-nome-link" data-invoice-id="' + inv.id + '" role="button" tabindex="0" title="Editar cliente">' + (inv.nome_cliente || '-') + '</span></td>' +
            '<td><span class="status ' + inv.status + ' clickable" data-invoice-id="' + inv.id + '" role="button" tabindex="0" title="Ver situações">' + inv.status + '</span></td>' +
            '<td>' + valor + '</td>' +
            '<td class="actions">' +
            ' <button type="button" class="btn-lupa btn-ver-chamada" data-invoice-id="' + inv.id + '" title="Editar nota"><i data-lucide="search"></i></button>' +
            ' <div class="actions-dropdown-wrap">' +
            '   <button type="button" class="btn-lupa btn-nfe-opcoes" data-invoice-id="' + inv.id + '" data-status="' + (inv.status || '') + '" title="Mais opções"><i data-lucide="ellipsis-vertical"></i></button>' +
            '   <div class="dropdown-nfe-opcoes" data-invoice-id="' + inv.id + '" data-status="' + (inv.status || '') + '">' +
            (inv.status === 'AUTORIZADO'
              ? '     <button type="button" class="dropdown-item" data-action="cancelar"><span class="dropdown-item-icon"><i data-lucide="globe"></i></span>Cancelar NF-e</button>'
              : '     <button type="button" class="dropdown-item" disabled title="Apenas para notas autorizadas"><span class="dropdown-item-icon"><i data-lucide="globe"></i></span>Cancelar NF-e</button>') +
            '     <button type="button" class="dropdown-item" data-action="outras-opcoes"><span class="dropdown-item-icon"><i data-lucide="globe"></i></span>Outras opções de NF-e</button>' +
            '     <button type="button" class="dropdown-item" data-action="carta-correcao"><span class="dropdown-item-icon"><i data-lucide="globe"></i></span>Carta de correção</button>' +
            '     <button type="button" class="dropdown-item" data-action="nfe-complementar"><span class="dropdown-item-icon"><i data-lucide="globe"></i></span>NFe complementar</button>' +
            '     <a href="' + (inv.pdf_url || base + '/fiscal/' + inv.id + '/pdf') + '" target="_blank" rel="noopener" class="dropdown-item" data-action="pdf"><span class="dropdown-item-icon"><i data-lucide="file-text"></i></span>Gerar PDF DANFE</a>' +
            '     <a href="' + (inv.xml_url || base + '/fiscal/' + inv.id + '/xml') + '" target="_blank" rel="noopener" class="dropdown-item" data-action="xml"><span class="dropdown-item-icon"><i data-lucide="file-code"></i></span>Ver XML</a>' +
            '     <button type="button" class="dropdown-item" data-action="gerar-devolucao"><span class="dropdown-item-icon"><i data-lucide="arrow-down"></i></span>Gerar devolução</button>' +
            '     <div class="dropdown-divider"></div>' +
            '     <button type="button" class="dropdown-item" data-action="clonar"><span class="dropdown-item-icon"><i data-lucide="copy"></i></span>Clonar nota</button>' +
            '     <button type="button" class="dropdown-item" data-action="clonar-entrada"><span class="dropdown-item-icon"><i data-lucide="copy"></i></span>Clonar para entrada</button>' +
            '     <div class="dropdown-divider"></div>' +
            '     <button type="button" class="dropdown-item" data-action="ver-json"><span class="dropdown-item-icon"><i data-lucide="file-json"></i></span>Ver JSON</button>' +
            '   </div></div>' +
            '</td></tr>'
          );
        }).join('') +
        '</tbody></table>';

      wrap.querySelectorAll('.status').forEach(function (el) {
        el.addEventListener('click', function () {
          const id = el.getAttribute('data-invoice-id');
          if (id) openModalSituacoes(id);
        });
      });
      wrap.querySelectorAll('.cliente-nome-link').forEach(function (el) {
        function openCliente() {
          const id = el.getAttribute('data-invoice-id');
          if (id) openModalClienteFromInvoice(id);
        }
        el.addEventListener('click', openCliente);
        el.addEventListener('keydown', function (e) {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openCliente(); }
        });
      });
      wrap.querySelectorAll('.btn-ver-chamada').forEach(function (el) {
        el.addEventListener('click', function () {
          const id = el.getAttribute('data-invoice-id');
          if (id) window.location.href = window.location.origin + '/painel/nf.html?invoiceId=' + encodeURIComponent(id);
        });
      });
      wrap.querySelectorAll('.btn-nfe-opcoes').forEach(function (btn) {
        btn.addEventListener('click', function (e) {
          e.stopPropagation();
          const wrap = btn.closest('.actions-dropdown-wrap');
          const dd = wrap && wrap.querySelector('.dropdown-nfe-opcoes');
          document.querySelectorAll('.dropdown-nfe-opcoes.open').forEach(function (d) {
            if (d !== dd) d.classList.remove('open');
          });
          if (dd) dd.classList.toggle('open');
        });
      });
      wrap.querySelectorAll('.dropdown-nfe-opcoes').forEach(function (dd) {
        dd.addEventListener('click', function (e) { e.stopPropagation(); });
      });
      wrap.querySelectorAll('.dropdown-nfe-opcoes .dropdown-item').forEach(function (el) {
        el.addEventListener('click', function (e) {
          if (el.tagName === 'A') return;
          if (el.disabled) { e.preventDefault(); return; }
          e.preventDefault();
          const action = el.getAttribute('data-action');
          const dd = el.closest('.dropdown-nfe-opcoes');
          const invoiceId = dd && dd.getAttribute('data-invoice-id');
          dd && dd.classList.remove('open');
          if (invoiceId) handleNfeOpcao(action, invoiceId);
        });
      });
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function renderPagination() {
      const container = document.getElementById('paginationContainer');
      if (!container) return;
      if (totalInvoicesCount === 0) {
        container.innerHTML = '';
        return;
      }
      const totalPages = totalInvoicesPages;
      if (totalPages <= 1) {
        container.innerHTML = '';
        return;
      }

      const firstItem = (currentInvoicePage - 1) * invoicesPerPage + 1;
      const lastItem = Math.min(currentInvoicePage * invoicesPerPage, totalInvoicesCount);

      let html = '<span class="pagination-summary">' + firstItem + '–' + lastItem + ' de ' + totalInvoicesCount + ' registros</span>';
      html += '<div class="pagination-nav-group">';

      html += '<button type="button" class="btn-page-nav" id="btnPagePrev"' + (currentInvoicePage === 1 ? ' disabled' : '') + '><i data-lucide="chevron-left"></i></button>';

      let startPage = Math.max(1, currentInvoicePage - 1);
      let endPage = Math.min(totalPages, currentInvoicePage + 1);
      if (currentInvoicePage === 1) { endPage = Math.min(totalPages, 3); }
      if (currentInvoicePage === totalPages) { startPage = Math.max(1, totalPages - 2); }

      if (startPage > 1) {
        html += '<button type="button" class="btn-page" data-page="1">1</button>';
        if (startPage > 2) html += '<span class="pagination-dots">···</span>';
      }

      for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === currentInvoicePage ? ' active' : '';
        html += '<button type="button" class="btn-page' + activeClass + '" data-page="' + i + '">' + i + '</button>';
      }

      if (endPage < totalPages) {
        if (endPage < totalPages - 1) html += '<span class="pagination-dots">···</span>';
        html += '<button type="button" class="btn-page" data-page="' + totalPages + '">' + totalPages + '</button>';
      }

      html += '<button type="button" class="btn-page-nav" id="btnPageNext"' + (currentInvoicePage === totalPages ? ' disabled' : '') + '><i data-lucide="chevron-right"></i></button>';
      html += '</div>';

      container.innerHTML = html;

      container.querySelectorAll('.btn-page').forEach(function (btn) {
        btn.addEventListener('click', function () {
          currentInvoicePage = parseInt(btn.getAttribute('data-page'), 10);
          loadInvoices();
        });
      });
      const btnPrev = container.querySelector('#btnPagePrev');
      if (btnPrev) btnPrev.addEventListener('click', function () {
        if (currentInvoicePage > 1) { currentInvoicePage--; loadInvoices(); }
      });
      const btnNext = container.querySelector('#btnPageNext');
      if (btnNext) btnNext.addEventListener('click', function () {
        if (currentInvoicePage < totalPages) { currentInvoicePage++; loadInvoices(); }
      });

      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    function renderPaginatedList() {
      // Obsoleto, usar loadInvoices diretamente agora
    }

    // ----- Custom dropdown genérico para .invoice-filter-select -----
    function initInvoiceFilterDropdowns() {
      var containers = document.querySelectorAll('.invoice-filter-select[data-filter-dropdown]');
      var dropdowns = [];

      containers.forEach(function (container) {
        var selectEl = container.querySelector('select[data-filter-source]');
        var hiddenInput = container.querySelector('.filter-hidden-input');
        var trigger = container.querySelector('[data-filter-trigger]');
        var valueEl = trigger && trigger.querySelector('.filter-dropdown-value');
        var menuEl = container.querySelector('[data-filter-menu]');
        if (!selectEl || !hiddenInput || !trigger || !valueEl || !menuEl) return;

        function syncFromSelect() {
          var value = selectEl.value || '';
          var selectedOpt = value
            ? Array.prototype.find.call(selectEl.options, function (o) { return o.value === value; })
            : null;

          hiddenInput.value = value;
          valueEl.textContent = selectedOpt ? selectedOpt.text : '';

          menuEl.innerHTML = '';
          for (var i = 0; i < selectEl.options.length; i++) {
            var opt = selectEl.options[i];
            if (opt.value === '') continue;
            var btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'filter-dropdown-option';
            if (opt.value === value) btn.classList.add('filter-option-selected');
            btn.dataset.value = opt.value;
            btn.textContent = opt.text;
            btn.addEventListener('click', (function (o, b) {
              return function () {
                selectEl.value = o.value;
                hiddenInput.value = o.value;
                valueEl.textContent = o.text;
                Array.prototype.forEach.call(menuEl.querySelectorAll('.filter-dropdown-option'), function (el) {
                  el.classList.toggle('filter-option-selected', el === b);
                });
                hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
                selectEl.dispatchEvent(new Event('change', { bubbles: true }));
                container.classList.remove('open');
              };
            }(opt, btn)));
            menuEl.appendChild(btn);
          }
          if (value) {
            var clearWrap = document.createElement('div');
            clearWrap.className = 'filter-dropdown-clear-wrap';
            var clearBtn = document.createElement('button');
            clearBtn.type = 'button';
            clearBtn.className = 'filter-dropdown-option filter-dropdown-clear';
            clearBtn.textContent = 'Limpar filtro';
            clearBtn.addEventListener('click', function () {
              selectEl.value = '';
              hiddenInput.value = '';
              valueEl.textContent = '';
              Array.prototype.forEach.call(menuEl.querySelectorAll('.filter-dropdown-option'), function (el) {
                el.classList.remove('filter-option-selected');
              });
              hiddenInput.dispatchEvent(new Event('change', { bubbles: true }));
              selectEl.dispatchEvent(new Event('change', { bubbles: true }));
              container.classList.remove('open');
            });
            clearWrap.appendChild(clearBtn);
            menuEl.appendChild(clearWrap);
          }
        }

        trigger.addEventListener('click', function (e) {
          e.preventDefault();
          e.stopPropagation();
          var isOpen = container.classList.contains('open');
          dropdowns.forEach(function (dd) { dd.container.classList.remove('open'); });
          if (!isOpen) {
            syncFromSelect();
            container.classList.add('open');
          }
        });

        dropdowns.push({ container: container, selectEl: selectEl, syncFromSelect: syncFromSelect });
        container._filterDropdown = { syncFromSelect: syncFromSelect, selectEl: selectEl };

        syncFromSelect();
      });

      document.addEventListener('click', function (e) {
        dropdowns.forEach(function (dd) {
          if (!dd.container.contains(e.target)) {
            dd.container.classList.remove('open');
          }
        });
      });
    }

    function syncFilterDropdownFromSelect(selectEl) {
      if (!selectEl) return;
      var container = selectEl.closest('.invoice-filter-select[data-filter-dropdown]');
      if (!container || !container._filterDropdown) return;
      container._filterDropdown.syncFromSelect();
    }

    function updateStatusFilterOptions() {
      var sel = document.querySelector('select#filterStatus[data-filter-source]');
      if (!sel) return;
      var current = sel.value || '';
      var statuses = [
        'AUTORIZADO', 'CANCELADO', 'DENEGADO', 'ERRO',
        'PENDENTE', 'PROCESSANDO', 'RASCUNHO', 'REJEITADO'
      ];
      sel.innerHTML = '';
      var placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Status';
      sel.appendChild(placeholder);
      statuses.forEach(function (s) {
        var opt = document.createElement('option');
        opt.value = s;
        opt.textContent = s;
        sel.appendChild(opt);
      });
      if (current && statuses.indexOf(current) !== -1) {
        sel.value = current;
      }
      syncFilterDropdownFromSelect(sel);
    }

    function applyInvoiceFilters() {
      currentInvoicePage = 1;
      loadInvoices();
    }

    async function loadEmpresasFiltro() {
      var sel = document.querySelector('select#filterEmpresa[data-filter-source]');
      if (!sel) return;
      sel.innerHTML = '';
      var placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'Empresa';
      sel.appendChild(placeholder);
      try {
        var res = await fetch(API + '/fiscal/empresas');
        var data = await res.json();
        if (!res.ok) {
          syncFilterDropdownFromSelect(sel);
          return;
        }
        var list = Array.isArray(data) ? data : [];
        list.forEach(function (e) {
          var nome = e.nome_fantasia || e.razao_social || '';
          var opt = document.createElement('option');
          opt.value = e.id;
          opt.textContent = nome;
          sel.appendChild(opt);
        });
      } catch (e) {
        // mantém apenas opção padrão em erro
      }
      syncFilterDropdownFromSelect(sel);
    }

    async function loadInvoices() {
      const wrap = document.getElementById('invoiceList');
      wrap.innerHTML = getInvoiceListSkeletonHtml();

      var searchEl = document.getElementById('filterPedido');
      var statusEl = document.getElementById('filterStatus');
      var empresaEl = document.getElementById('filterEmpresa');
      var search = searchEl && searchEl.value ? searchEl.value.trim() : '';
      var status = statusEl ? statusEl.value : '';
      var empresaId = empresaEl && empresaEl.value ? empresaEl.value : '';

      const params = new URLSearchParams({
        page: currentInvoicePage,
        limit: invoicesPerPage
      });
      if (search) params.append('search', search);
      if (status) params.append('status', status);
      if (empresaId) params.append('empresa', empresaId);

      try {
        const res = await fetch(API + '/fiscal/invoices?' + params.toString());
        const json = await res.json();

        if (!res.ok) {
          wrap.innerHTML = '<div class="empty">Erro ao carregar lista.</div>';
          return;
        }

        let list = [];
        if (Array.isArray(json)) {
          // fallback if backend is old
          list = json;
          totalInvoicesCount = list.length;
          totalInvoicesPages = 1;
        } else if (json.data && Array.isArray(json.data)) {
          list = json.data;
          totalInvoicesCount = json.totalItems || list.length;
          totalInvoicesPages = json.totalPages || 1;
        }

        if (!list.length) {
          wrap.innerHTML = '<div class="empty">Nenhuma nota encontrada.</div>';
          renderPagination();
          return;
        }
        renderInvoiceTable(list);
        updateStatusFilterOptions();
        renderPagination();
      } catch (e) {
        wrap.innerHTML = '<div class="empty">Erro: ' + e.message + '</div>';
      }
    }

    (function initNavegacaoNF() {
      var btnIncluir = document.getElementById('btnIncluirNF');
      if (btnIncluir) {
        btnIncluir.addEventListener('click', function () {
          window.location.href = window.location.origin + '/painel/nf.html';
        });
      }
    })();

    document.getElementById('btnSync').addEventListener('click', async function () {
      const btn = document.getElementById('btnSync');
      btn.disabled = true;
      btn.innerHTML = '<i data-lucide="refresh-ccw"></i> Sincronizando…';
      if (typeof lucide !== 'undefined') lucide.createIcons();
      try {
        const res = await fetch(API + '/fiscal/sync', { method: 'POST' });
        const data = await res.json();
        if (data.atualizados > 0 || data.erro > 0) {
          showMessage('msg', 'Sincronização: ' + data.atualizados + ' atualizada(s), ' + data.erro + ' erro(s).', data.atualizados > 0 ? 'success' : 'info');
        }
        loadInvoices();
      } catch (e) {
        showMessage('msg', 'Erro ao sincronizar: ' + e.message, 'error');
      }
      btn.disabled = false;
      btn.innerHTML = '<i data-lucide="refresh-ccw"></i> Sincronizar status';
      if (typeof lucide !== 'undefined') lucide.createIcons();
    });

    (function initInvoiceFilters() {
      var searchEl = document.getElementById('filterPedido');
      var searchBtn = document.getElementById('filterPedidoSearchBtn');
      var statusEl = document.getElementById('filterStatus');
      var empresaEl = document.getElementById('filterEmpresa');
      var debounceTimer;

      function debounceApply() {
        if (debounceTimer) clearTimeout(debounceTimer);
        debounceTimer = setTimeout(applyInvoiceFilters, 250);
      }

      if (searchEl) {
        searchEl.addEventListener('input', debounceApply);
        searchEl.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            applyInvoiceFilters();
          }
        });
      }
      if (searchBtn) {
        searchBtn.addEventListener('click', function () {
          applyInvoiceFilters();
        });
      }
      if (statusEl) {
        statusEl.addEventListener('change', applyInvoiceFilters);
      }
      if (empresaEl) {
        empresaEl.addEventListener('change', applyInvoiceFilters);
      }
    })();

    initInvoiceFilterDropdowns();
    loadEmpresasFiltro();
    loadInvoices();
    if (typeof lucide !== 'undefined') lucide.createIcons();
  </script>
</body>

</html>